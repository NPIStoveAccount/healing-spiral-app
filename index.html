<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Healing Spiral - Interactive Guide</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0a0a0f; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  #root { min-height: 100vh; }
</style>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useMemo } = React;

/* ━━ colour tokens ━━ */
const C = {
  bg:"#0a0a0f",card:"#12121a",cardH:"#1a1a28",bdr:"#2a2a3a",
  tx:"#d4d4dc",txM:"#8888a0",txL:"#f0f0f5",
  acc:"#6b9b7d",accL:"#8bbf9f",
  gnd:"#4a6a8a",gndL:"#6a8aaa",
  som:"#c4785a",somL:"#e09878",
  psy:"#7a8ac4",psyL:"#9aaae4",
  idn:"#b07aaa",idnL:"#d09aca",
  eng:"#c4a84a",engL:"#e0c86a",
  shd:"#9a6ab0",shdL:"#ba8ad0",
  warn:"#c45a5a",warnL:"#e07a7a",
  eff:"#5a9a6a",par:"#a09050",ineff:"#8a4a4a",ineffTx:"#c47070",
  strong:"#4aaa5a",moderate:"#aaa04a",weak:"#aa5a4a",none:"#5a4a4a",
};

/* ━━ Modalities master list (id → display name) ━━ */
const MODS = {
  step12:"12-Step Programs",ifs:"IFS",gestalt:"Gestalt",se:"Somatic Experiencing",
  sm:"Sensorimotor Psychotherapy",biocore:"Bioenergetics / Core Energetics",
  rc:"RC (Re-evaluation Counseling)",tre:"TRE",men:"Men/Women Group Therapy",
  talk:"Talk Therapy",cbt:"CBT",dbt:"DBT",act:"ACT",
  jung:"Jungian Analysis",psychodyn:"Psychoanalysis / Psychodynamic",
  istdp:"ISTDP",emdr:"EMDR / Brainspotting",hakomi:"Hakomi",
  emres:"EmRes",nlp:"NLP",hypno:"Hypnotherapy",
  art:"Art Therapy",music:"Music / Voice Work",drama:"Drama Therapy",
  nfb:"Neurofeedback",circ:"Circling / Relatefulness",
  nvc:"NVC",eft:"EFT (Couples)",grpther:"Group Therapy (Process)",
  fam:"Family Constellations",cuddle:"Cuddle Therapy",forum:"Forum / LGAT",
  exkink:"Existential Kink",maha:"Mahamudra",vip:"Vipassana",zen:"Zen",
  dzog:"Dzogchen",adv:"Advaita Vedanta",real:"Realization Process",
  cenpr:"Centering Prayer",sufi:"Sufism / Whirling",kirtan:"Kirtan / Chanting",
  yoga:"Yoga / Yoga Nidra",kundy:"Kundalini Yoga",hrid:"Hridaya Yoga",
  taichi:"Tai Chi / Qigong",martial:"Martial Arts (Internal)",
  ci:"Contact Improvisation",rhythms:"5Rhythms / Ecstatic Dance",
  feld:"Feldenkrais / Alexander",rolf:"Rolfing / Structural Integration",
  cranio:"Craniosacral Therapy",massage:"Massage / Bodywork",
  acu:"Acupuncture / TCM",plant:"Plant Medicine",holo:"Holotropic Breathwork",
  wimhof:"Wim Hof Method",nature:"Deep Nature Connection",
  vision:"Vision Quest",sweat:"Sweat Lodge",hoop:"Ho'oponopono",
  float:"Float Tanks",vns:"Vagus Nerve Stimulation",ket:"Ketamine Therapy",
};

const MOD_KEYS = Object.keys(MODS).sort((a,b) => MODS[a].localeCompare(MODS[b]));

/* ━━ Dimensions data using mod IDs ━━ */
const mkE = (id, role) => ({id, name:MODS[id], role});
const mkI = (id, reason) => ({id, name:MODS[id], reason});

const DIMS = [
  { id:"ground", name:"Relational Field", plainName:"Relational Field", zone:"Ground", color:C.gnd, colorL:C.gndL,
    short:"The medium in which all healing occurs",
    desc:"Not a dimension alongside the others but the ground of all healing. Quality of presence, attunement, co-regulation, and witnessing determines whether any other dimension shifts or is merely performed.",
    eff:[mkE("step12","Community, sponsorship, ongoing co-regulation"),mkE("men","Deep witnessing, belonging, being seen by peers"),mkE("rc","Peer exchange, co-attention, mutual presence"),mkE("circ","Primary relational practice — present-moment group attunement"),mkE("nvc","Empathic listening and authentic expression"),mkE("cuddle","Direct co-regulation through safe, boundaried touch"),mkE("ci","Relational attunement through movement"),mkE("eft","Directly restructures attachment bonds"),mkE("grpther","Relational field where interpersonal patterns emerge in real time"),mkE("hoop","Forgiveness practice that heals relational ruptures")],
    par:[mkE("ifs","Depends on therapist attunement"),mkE("gestalt","Strong in I-Thou contact; weaker in exercise-driven formats"),mkE("se","Co-regulation through practitioner, but one-directional"),mkE("hakomi","Therapist presence is central, but still a dyad"),mkE("fam","Group resonance reveals dynamics, but facilitated not peer-based"),mkE("plant","MDMA powerful for relational repair; quality varies"),mkE("nature","Relationship with more-than-human — genuine but not interpersonal"),mkE("rhythms","Shared movement creates group field"),mkE("drama","Contact through theatrical distance"),mkE("sweat","Shared ordeal builds bonding"),mkE("forum","Intense bonding but manufactured intensity"),mkE("kirtan","Group chanting creates communal resonance and shared vulnerability"),mkE("sm","Therapist attunement in dyad; one-directional but embodied"),mkE("psychodyn","Transference relationship provides relational field — structured")],
    ineff:[mkI("talk","Professional distance prevents genuine co-regulation"),mkI("exkink","Primarily intrapsychic"),mkI("maha","Solo practice; can reinforce withdrawal"),mkI("vip","Solo practice; can reinforce withdrawal"),mkI("zen","Solo practice; can reinforce withdrawal"),mkI("nlp","Technique-focused, not relational"),mkI("emdr","Intrapsychic processing"),mkI("cbt","Skill-based, manualized"),mkI("nfb","Human-machine interface"),mkI("float","Solitary by design"),mkI("hypno","Primarily intrapsychic; therapist-directed not relational"),mkI("ket","Altered state is solo even when facilitated")],
  },
  { id:"capacity", name:"Capacity Building", plainName:"Building Stability", zone:"Foundation", color:C.acc, colorL:C.accL,
    short:"Nervous system regulation + relational safety",
    desc:"The system needs enough resources to enter difficult territory without overwhelm. Both internal (pendulation) and external (relational safety). Scales with depth. Ongoing throughout the spiral.",
    eff:[mkE("se","Primary — grounding, resourcing, pendulation, titration"),mkE("tre","Neurogenic tremoring gradually releases tension. Self-directed, accumulative"),mkE("yoga","Breath, posture, interoception. Yoga Nidra trains settling between states"),mkE("nfb","Directly trains nervous system regulation — unique mechanism"),mkE("rc","Co-attention creates safety; structured turns build predictability"),mkE("step12","Community holding; sponsorship as reliable co-regulation"),mkE("nature","Nature as co-regulator — sensory grounding, resilience"),mkE("dbt","Distress tolerance and emotion regulation skills"),mkE("taichi","Slow regulated movement builds interoceptive awareness"),mkE("float","Sensory reduction lets nervous system settle to baseline"),mkE("vns","Direct toning of vagal pathways")],
    par:[mkE("men","Group containment helps, but some formats push intensity first"),mkE("maha","Shamatha builds capacity; often taught too advanced"),mkE("vip","Retreat structure provides container; can be too intense"),mkE("gestalt","Body awareness helps, but privileges contact over resourcing"),mkE("cuddle","Co-regulation through touch; doesn't develop self-regulation"),mkE("emres","Resolves charge, but works by resolving not building"),mkE("massage","Settles through touch; often temporary"),mkE("feld","Somatic awareness indirectly supports regulation"),mkE("act","Psychological flexibility — more cognitive than somatic"),mkE("wimhof","Stress tolerance through controlled challenge"),mkE("cranio","Gentle settling; helpful but passive"),mkE("sm","Teaches body-based self-regulation within therapeutic frame"),mkE("hypno","Trance induction builds capacity for state shifts; teaches self-regulation"),mkE("acu","Regulates autonomic nervous system through meridian work"),mkE("martial","Disciplined practice builds stress tolerance and body regulation"),mkE("eft","Safe attachment provides co-regulation base in primary relationship")],
    ineff:[mkI("talk","Cognitive understanding but rarely nervous system capacity"),mkI("exkink","Requires existing capacity — doesn't build it"),mkI("ifs","Can map parts before system has enough ground"),mkI("plant","Opens by chemical force rather than building regulation"),mkI("istdp","Builds pressure, not capacity"),mkI("nlp","Reframes cognition, doesn't develop somatic regulation"),mkI("fam","Can surface overwhelming material before capacity exists"),mkI("holo","Deliberately induces altered states — bypasses capacity building"),mkI("forum","Can overwhelm through manufactured intensity"),mkI("cbt","Cognitive tools, not nervous system development"),mkI("ket","Chemical shortcut to altered state — doesn't build organic regulation"),mkI("kundy","Can overwhelm capacity rather than build it")],
  },
  { id:"completion", name:"Physiological Completion", plainName:"Completing Body Reactions", zone:"Body", color:C.som, colorL:C.somL,
    short:"Finishing thwarted survival responses",
    desc:"The body holds incomplete fight, flight, freeze, fawn, collapse. Completion means finishing what was started. Different from catharsis: genuine completion produces spontaneous settling and a new baseline.",
    eff:[mkE("se","Primary — tracking impulses, completing with titration"),mkE("sm","Tracks and completes somatic sequences with cognitive integration"),mkE("biocore","Direct work with muscular armoring and expressive bodywork"),mkE("rc","Discharge: trembling, crying, laughing, raging, yawning"),mkE("tre","Body's natural shaking response. Simple, self-directed"),mkE("gestalt","Body awareness, here-and-now tracking, permission for expression")],
    par:[mkE("men","Physical expression with holding — often lacks titration"),mkE("ifs","Can facilitate body response when accessing exiles"),mkE("plant","Powerful somatic releases but chemically paced"),mkE("yoga","Trauma-sensitive yoga allows movement through stuck patterns"),mkE("emdr","Can unlock frozen responses during reprocessing"),mkE("holo","Powerful activation — intensity can overwhelm"),mkE("rolf","Fascial work releases patterns — mechanical rather than autonomic"),mkE("rhythms","Free movement can access stuck impulses"),mkE("hakomi","Mindful tracking facilitates completion through experiments"),mkE("drama","Enactment can complete thwarted responses"),mkE("ci","Free movement may facilitate if impulse arises"),mkE("martial","Training fight responses can complete self-defense impulses"),mkE("massage","Deep tissue can release held patterns — lacks autonomic tracking"),mkE("feld","Somatic awareness reveals held patterns — indirect completion"),mkE("cranio","Subtle unwinding at tissue level — very gentle completion"),mkE("ket","Can unlock frozen states; lacks body's own pacing")],
    ineff:[mkI("talk","Narrative cannot complete thwarted fight/flight"),mkI("cbt","Cognitive — doesn't reach physiology"),mkI("exkink","Meaning/identity level"),mkI("maha","Observation without completion freezes body in witness mode"),mkI("vip","Noting without completing"),mkI("zen","Sitting without completing"),mkI("step12","No somatic mechanism"),mkI("nvc","Communication framework"),mkI("nlp","Cognitive layer"),mkI("istdp","Bypasses body's own timing"),mkI("jung","Image and symbol — doesn't reach somatic layer"),mkI("nfb","Trains regulation, not specific completion"),mkI("hypno","Trance bypasses body's autonomous completion timing")],
  },
  { id:"affect", name:"Affect Metabolization", plainName:"Processing Buried Emotions", zone:"Body → Psyche", color:C.som, colorL:C.somL,
    short:"Slowly digesting what couldn't be felt",
    desc:"Frozen material surfaces — grief under anger, terror under numbness, longing under self-sufficiency. Metabolization is sustained conscious contact: not acting out, not analyzing, not transcending. Comes in waves.",
    eff:[mkE("gestalt","Primary — present-moment aliveness, permission for full feeling"),mkE("rc","Discharge as emotional release; attention underneath patterns"),mkE("ifs","Accessing exiles, witnessing with Self-energy"),mkE("men","Full emotional range with group witnessing"),mkE("biocore","Bodywork opens armoring, directly releasing held affect"),mkE("istdp","Designed to break through defenses to core affect"),mkE("hakomi","Gentle access through somatic awareness and relational safety"),mkE("music","Sound accesses emotion words can't reach"),mkE("art","Visual expression bypasses verbal defenses")],
    par:[mkE("se","Tracks waves but may lack psychological framework"),mkE("sm","Integrates cognitive but somatic-first"),mkE("step12","Step 4-5 surfaces affect but doesn't emphasize staying"),mkE("plant","Surfaces overwhelming amounts. MDMA helps. Flood not titration"),mkE("emres","Resolves charge — may resolve before fully felt"),mkE("circ","Real-time contact metabolizes relational emotions"),mkE("emdr","Facilitates processing indirectly"),mkE("fam","Surfaces intergenerational affect; single session limits"),mkE("nature","Nature holds big emotions"),mkE("holo","Deep material through altered states — can overwhelm"),mkE("rhythms","Movement accesses emotion below verbal level"),mkE("jung","Active imagination accesses deep affect through image"),mkE("psychodyn","Transference surfaces relational affect slowly"),mkE("drama","Theatrical frame makes unbearable feelings approachable"),mkE("kirtan","Opens heart, surfaces grief and longing"),mkE("sweat","Ordeal cracks open armoring"),mkE("ket","Breaks through depressive freeze; opens emotional access temporarily"),mkE("hypno","Regression accesses frozen affect; therapist-paced not organism-paced"),mkE("yoga","Certain postures and breathwork surface held emotions"),mkE("grpther","Group dynamics surface relational emotions in real time")],
    ineff:[mkI("talk","Discusses feelings about feelings — intellectual distance"),mkI("cbt","Cognitive restructuring, not metabolization"),mkI("exkink","Reframes rather than metabolizes"),mkI("maha","Noting rather than feeling — awareness as avoidance"),mkI("vip","Same risk as Mahamudra"),mkI("zen","Same risk"),mkI("nlp","Rapidly reframes rather than allowing feeling"),mkI("nvc","Names feelings but doesn't facilitate metabolization"),mkI("dbt","Manages affect, not metabolizes"),mkI("act","Acceptance sidesteps metabolization"),mkI("nfb","Regulates but doesn't access specific material"),mkI("float","Sensory reduction — no emotional access mechanism")],
  },
  { id:"diff", name:"Differentiation", plainName:"Telling Past from Present", zone:"Psyche", color:C.psy, colorL:C.psyL,
    short:"Distinguishing what was previously fused",
    desc:"Past from present. Part from whole self. Feeling from story. Awareness from content. Increased space between stimulus and response. Without somatic/affect work first, becomes mere intellectual mapping.",
    eff:[mkE("ifs","Primary — unblending from parts, Self from protectors and exiles"),mkE("gestalt","Contact boundaries, figure/ground, self vs. environment"),mkE("maha","Most radical — awareness from all content"),mkE("vip","Noting builds fine-grained differentiation"),mkE("dzog","Rigpa from sem"),mkE("zen","Koans develop radical clarity"),mkE("rc","'Pattern is not the person'"),mkE("real","Embodied nondual — ground of being from content while in body"),mkE("nvc","Observations vs. evaluations, feelings vs. thoughts, needs vs. strategies"),mkE("hakomi","Precise tracking: sensation, feeling, impulse, belief as distinct")],
    par:[mkE("talk","Cognitive distinctions without felt-sense remain abstract"),mkE("psychodyn","Builds distinction through interpretation — slow"),mkE("se","Body tracking supports differentiation but lacks structural map"),mkE("emdr","Creates distance from traumatic memories — byproduct"),mkE("emres","Tracking sensations distinct from narratives"),mkE("fam","'Mine' vs. inherited — intergenerational differentiation"),mkE("jung","Ego from shadow, persona from Self"),mkE("cbt","Thoughts vs. facts — limited to cognitive layer"),mkE("act","Cognitive defusion — thoughts as thoughts"),mkE("dbt","Wise mind: emotional vs. rational"),mkE("feld","Fine-grained somatic: habitual vs. novel, effort vs. ease"),mkE("sm","Separating somatic experience from emotional narrative"),mkE("hypno","Trance states can distinguish subconscious from conscious patterns"),mkE("adv","Self-inquiry distinguishes awareness from content")],
    ineff:[mkI("step12","'I am an addict' fuses identity with pattern"),mkI("men","Group intensity can blur boundaries"),mkI("exkink","Collapses distinctions — useful later, counterproductive here"),mkI("plant","Dissolves boundaries — de-differentiation"),mkI("nlp","Reframes without felt-sense foundation"),mkI("istdp","Intensity blurs rather than clarifies"),mkI("biocore","Catharsis can overwhelm distinction-making"),mkI("holo","Altered states dissolve boundaries"),mkI("forum","Group pressure blurs self/other"),mkI("ket","De-differentiating by design — dissolves boundaries")],
  },
  { id:"models", name:"Implicit Model Updating", plainName:"Updating Deep Beliefs", zone:"Psyche", color:C.psy, colorL:C.psyL,
    short:"Rewriting embodied predictions through corrective experience",
    desc:"Old prediction active + disconfirming experience + awareness of mismatch = lasting change. This is why insight alone doesn't heal and relational field is central.",
    eff:[mkE("step12","Amends as corrective relational experience; community disconfirms isolation"),mkE("ifs","Self meets parts with what they needed; updates exile beliefs"),mkE("men","Vulnerability met with presence; discovering belonging"),mkE("circ","Real-time contact continuously disconfirms old predictions"),mkE("emdr","Memory reconsolidation directly updates encodings — strong evidence"),mkE("fam","Reveals and reorganizes inherited relational models"),mkE("eft","Corrective attachment in the primary relationship"),mkE("psychodyn","Working through transference — old model met with something new"),mkE("grpther","Interpersonal patterns worked in real time with multiple others")],
    par:[mkE("gestalt","Experiments create corrective experience; depends on context"),mkE("rc","Peer presence disconfirms; format limits depth"),mkE("se","Practitioner's presence implicitly corrects attachment predictions"),mkE("plant","MDMA: ideal reconsolidation conditions. Must consolidate sober"),mkE("cuddle","Updates touch/vulnerability predictions — limited range, potent"),mkE("nvc","New patterns create corrective experience — can be formulaic"),mkE("nlp","Rapidly reframes beliefs — real but shallow"),mkE("hakomi","Missing experience experiments provide what was absent"),mkE("drama","Role reversal creates corrective experience"),mkE("hoop","Updates models about rupture and repair"),mkE("ci","Physical trust updates safety predictions"),mkE("forum","Powerful breakthroughs — manufactured context may not transfer"),mkE("hypno","Suggestion can reframe beliefs; reconsolidation-adjacent under trance"),mkE("ket","Neuroplasticity window enables model updating; must integrate sober"),mkE("art","Creating new images of self and relationship updates predictions indirectly"),mkE("sm","Corrective somatic experience updates body-level predictions")],
    ineff:[mkI("talk","Insight doesn't update embodied predictions"),mkI("cbt","Knowing doesn't change body's prediction"),mkI("maha","Transcends rather than updates — predictions unchanged"),mkI("vip","Equanimity overlays unchanged predictions"),mkI("zen","Same issue"),mkI("exkink","Reframes without corrective relational experience"),mkI("tre","Releases tension but not relational"),mkI("nfb","Trains regulation, not specific predictions"),mkI("jung","Symbolic without lived corrective experience"),mkI("float","No relational corrective mechanism")],
  },
  { id:"identity", name:"Identity Reorganization", plainName:"Letting Identity Shift", zone:"Identity / Existential", color:C.idn, colorL:C.idnL,
    short:"Letting old self-structures dissolve",
    desc:"As enough models update, the identity they supported loses coherence. Can't be forced; happens when underlying material has shifted. Premature attempts produce spiritual bypass.",
    eff:[mkE("step12","Surrender — letting go of ego's control, Steps 1-3"),mkE("exkink","Exposes shadow investment in old identity"),mkE("maha","All identity structures as fixations of awareness"),mkE("dzog","Self-liberation as practice"),mkE("men","Initiatory processes; dying to old self in community"),mkE("real","Embodied nondual — dissolves identification while in body"),mkE("jung","Individuation: shadow, anima/animus, Self"),mkE("zen","Koans systematically break conceptual identity"),mkE("adv","Direct self-inquiry dissolves identification"),mkE("vision","Solo wilderness ordeal as death and rebirth")],
    par:[mkE("ifs","Unburdening updates parts but not always the larger structure"),mkE("gestalt","Can facilitate shifts but lacks explicit framework"),mkE("plant","Powerful ego dissolution — catalytic with prior work; risk of new identity"),mkE("nature","Soulcraft tradition works identity through nature"),mkE("fam","Dissolves identification with family roles"),mkE("vip","Insight into anatta — often stays intellectual"),mkE("holo","Can produce ego dissolution — same caveats as plant medicine"),mkE("sufi","Fana — ego annihilation through love"),mkE("cenpr","Christian contemplative surrender through devotion"),mkE("sweat","Ceremonial death and rebirth"),mkE("psychodyn","Long-term analysis can produce transformation — slow"),mkE("ket","Ego dissolution through dissociation — powerful but chemical"),mkE("hrid","Heart opening can dissolve identity through love"),mkE("kundy","Kundalini rising can shatter identity structures — uncontrolled"),mkE("art","Creative identity exploration — becoming through making"),mkE("music","Voice work can crack open persona; singing as someone else")],
    ineff:[mkI("talk","Reinforces coherent narrative identity"),mkI("cbt","Works within existing identity"),mkI("rc","Pattern removal doesn't address deeper structure"),mkI("se","Below identity level — preparation not dissolution"),mkI("nlp","Installs new identity rather than dissolution"),mkI("nvc","Communication framework"),mkI("emdr","Reprocesses memories not architecture"),mkI("tre","Far below identity level"),mkI("emres","Resolves charge not identity"),mkI("dbt","Skill-building within existing identity"),mkI("nfb","No identity mechanism"),mkI("hypno","Can install new identity narratives but not genuine dissolution")],
  },
  { id:"energetic", name:"Energetic Reorganization", plainName:"Subtle Body Shifts", zone:"Subtle Body", color:C.eng, colorL:C.engL,
    short:"Felt-sense shifts between gross somatic and psychological meaning",
    desc:"More granular than muscular tension, more embodied than parts. Maps as meridians, chakras, nadis. Operates independently — sometimes preceding, following, or catalyzing the cascade. Requires soft, receptive attention.",
    eff:[mkE("se","Felt-sense tracking at subtle level — Levine's 'felt sense'"),mkE("maha","Tsa lung, tummo — explicit channels and winds"),mkE("biocore","Directly works with energetic blocks and character as energy pattern"),mkE("plant","Strongest catalyst for subtle body shifts — traditional contexts understand this"),mkE("hrid","Heart-centered subtle energy and nondual awareness"),mkE("yoga","Pranayama works with prana; Yoga Nidra accesses subtle states"),mkE("kundy","Specifically targets energetic awakening"),mkE("real","Subtle internal space of body as ground of being"),mkE("acu","Directly works meridian system — thousands of years refined"),mkE("taichi","Qi cultivation through intentional movement"),mkE("cranio","Subtle rhythms and fluid dynamics — extremely gentle")],
    par:[mkE("gestalt","Felt-sense tracking can touch this when refined"),mkE("rc","Discharge occasionally touches energetic shifts"),mkE("men","Group field produces shifts — typically unrecognized"),mkE("tre","Tremoring can release energetic blocks as side effect"),mkE("holo","Powerful energetic activation — kundalini phenomena — uncontrolled"),mkE("rolf","Fascial work releases energy — piezoelectric properties"),mkE("rhythms","Free movement opens energy channels"),mkE("hakomi","Subtle awareness embedded but not explicitly named"),mkE("wimhof","Strong energetic sensations — physiological not energetic framework"),mkE("massage","Thai massage works energy lines; western releases through tissue"),mkE("float","Sensory reduction increases subtle awareness — passive"),mkE("sufi","Whirling as subtle body practice"),mkE("ci","Subtle energy exchange between bodies"),mkE("nature","Attuning to natural energies — felt sense of place"),mkE("ket","Can produce strong energetic phenomena — dissociative not integrative"),mkE("kirtan","Sound vibration resonates through subtle body — devotional energy"),mkE("martial","Internal martial arts cultivate and direct qi"),mkE("feld","Somatic awareness at subtle level bridges gross and energetic")],
    ineff:[mkI("talk","Cognitive — no subtle body access"),mkI("cbt","No subtle body access"),mkI("psychodyn","Cognitive/symbolic level"),mkI("ifs","Psychological not energetic"),mkI("step12","No mechanism"),mkI("exkink","Meaning/identity level"),mkI("nvc","Communication framework"),mkI("nlp","Cognitive repatterning"),mkI("emdr","Neurological not energetic"),mkI("istdp","Emotional breakthrough — no energetic dimension"),mkI("dbt","Skill-based"),mkI("nfb","Neural not energetic"),mkI("jung","Symbolic — doesn't directly address subtle body"),mkI("hypno","Works through suggestion not energetic channels")],
  },
  { id:"shadow", name:"Shadow Integration / Integrity", plainName:"Reclaiming What Was Rejected", zone:"Wholeness", color:C.shd, colorL:C.shdL,
    short:"Re-owning what was banished from self-experience",
    desc:"Other dimensions work with what's stuck. Shadow integration works with what's split off — actively excluded from self-experience. The mechanism isn't completion or metabolization but re-owning. Integrity as structural wholeness: nothing left out. At every level of the cascade, there's material that was forbidden rather than merely unfelt.",
    eff:[mkE("exkink","Primary — makes conscious the hidden desire in what you claim to not want"),mkE("jung","Classical shadow tradition; shadow, anima/animus, individuation"),mkE("ifs","Shadow work through exile access; exiled parts ARE the shadow, Self witnessing is re-owning"),mkE("men","Confrontation and mirroring surface disowned aspects in peer field"),mkE("step12","Steps 4-5 moral inventory; amends as facing what was hidden"),mkE("gestalt","'Be the part you're disowning' — polarities, empty chair, owning projections"),mkE("maha","Most radical: awareness itself has no shadow because nothing is excluded"),mkE("dzog","Rigpa includes everything — ultimate non-exclusion"),mkE("plant","Ayahuasca especially can forcefully surface shadow material")],
    par:[mkE("psychodyn","Classical projection analysis; slow but genuine"),mkE("circ","Real-time mirroring reveals blind spots"),mkE("grpther","Group dynamics surface projections and disowned roles"),mkE("rc","Discharge sometimes touches forbidden material; format limits depth"),mkE("biocore","Muscular armoring holds forbidden impulses — releases can surface shadow"),mkE("drama","Role-play as disowned parts; theatrical distance enables contact"),mkE("art","Unconscious material surfaces through image"),mkE("fam","Reveals disowned family roles and inherited shadow"),mkE("holo","Intense states can crack open defended material"),mkE("adv","Self-inquiry exposes identification, but can bypass relational shadow"),mkE("music","Voice work can access forbidden expression"),mkE("rhythms","Free movement reveals disowned impulses"),mkE("forum","Intense confrontation surfaces shadow — manufactured context"),mkE("hypno","Regression can surface repressed material; therapist-guided not self-discovered"),mkE("sweat","Ordeal strips defenses, reveals what's underneath"),mkE("vision","Solo wilderness confronts what's usually avoided"),mkE("ket","Can surface shadow material — dissociative access, not re-owning")],
    ineff:[mkI("talk","Conversation reinforces the narrator — shadow stays hidden behind story"),mkI("cbt","Works within conscious frame; cannot access what's excluded from awareness"),mkI("se","Somatic tracking of what's present; not designed for what's actively excluded"),mkI("emdr","Reprocesses memories, not split-off identity structures"),mkI("nfb","No mechanism for accessing disowned material"),mkI("dbt","Skill-building within existing self-concept"),mkI("act","Acceptance of experience as-is; doesn't address active exclusion"),mkI("nlp","Reframes within existing narrative; shadow remains projected"),mkI("nvc","Communication framework — doesn't address what's disowned"),mkI("tre","Releases tension but not split-off psychological material"),mkI("float","Sensory reduction — no shadow mechanism"),mkI("vns","Physiological only"),mkI("yoga","Body practice — doesn't address what's actively excluded from self"),mkI("taichi","Movement practice — no shadow mechanism"),mkI("massage","Body relaxation — no shadow access")],
  },
];

const CASCADE = ["capacity","completion","affect","diff","models","identity"];

const LOOPS = [
  {from:"identity",to:"capacity",label:"Identity dissolution destabilizes, requiring renewed resourcing",plain:"When your sense of self starts to shift, it can be destabilizing — you need to rebuild stability"},
  {from:"completion",to:"affect",label:"Body completion surfaces frozen emotional material",plain:"As the body releases, buried emotions come to the surface"},
  {from:"affect",to:"diff",label:"Feeling what was unfelt reveals what was fused",plain:"Feeling old emotions helps you tell apart past from present"},
  {from:"models",to:"completion",label:"Updated models unlock deeper body patterns",plain:"As old beliefs change, deeper body patterns become available to release"},
  {from:"identity",to:"models",label:"Identity shift reveals more foundational predictions",plain:"When identity shifts, even deeper beliefs become visible"},
  {from:"energetic",to:"affect",label:"Energetic opening surfaces inaccessible affects",plain:"Subtle body shifts can bring up emotions that were previously unreachable"},
  {from:"completion",to:"energetic",label:"Physical completion produces spontaneous energetic shifts",plain:"Body releases often produce subtle energy shifts naturally"},
  {from:"shadow",to:"affect",label:"Re-owning split-off material releases frozen affect",plain:"Reclaiming rejected parts of yourself releases locked-up emotions"},
  {from:"identity",to:"shadow",label:"Identity dissolution reveals what identity was organized to exclude",plain:"As identity softens, you can see what you've been hiding from yourself"},
  {from:"shadow",to:"models",label:"Reclaiming projections updates relational predictions",plain:"Owning what you've projected onto others changes your relationship patterns"},
  {from:"diff",to:"shadow",label:"Differentiation makes shadow material visible as 'not-me'",plain:"Being able to distinguish your parts helps you see what you've pushed away"},
];

const TRAPS = [
  {name:"Spiritual Bypass",
    desc:"Using top-down practices to avoid bottom-up work. Transcendence becomes a way to not feel.",
    looks:"You can describe your patterns eloquently. You have a meditation practice and real experiences of spaciousness. But your body is still braced, your relationships still hit the same walls, and there's a subtle superiority in how you hold your equanimity.",
    signs:["Calm that collapses under relational stress","Emotional range narrower than before practice","Subtle contempt for 'less conscious' people","'I've already dealt with that' about material that's clearly alive"],
    antidote:"Add body-based and relational work. Let yourself not know. Let someone see you fall apart. The ground floor has to be built, not bypassed.",
    dims:["identity","diff"],risk:["maha","vip","zen","dzog","adv","real","exkink","cenpr"]},
  {name:"Intellectualization",
    desc:"Understanding without transformation. You can map every pattern but nothing actually shifts.",
    looks:"You've read the books, know the frameworks, can explain your attachment style and your mother's. Your therapist is impressed. But you're still in the same loop — you just narrate it better now.",
    signs:["Insight without behavioral change","Explaining feelings rather than feeling them","'I know why I do this' without being able to stop","Therapy that feels productive but changes nothing"],
    antidote:"Move from talking about experience to having experience. Body work, group work, anything that puts you in contact with what you're describing from a distance.",
    dims:["diff","models"],risk:["talk","cbt","ifs","jung","nlp","act"]},
  {name:"Catharsis Without Integration",
    desc:"Dramatic emotional or somatic experiences that don't reorganize the system. The discharge feels real but doesn't stick.",
    looks:"You've had huge releases — screaming, shaking, sobbing, visionary experiences. They feel cathartic in the moment, maybe for days after. But you keep having the same kind of release about the same material. The baseline doesn't shift.",
    signs:["Repeated intense experiences without lasting change","Seeking increasingly dramatic modalities","'Breakthrough' experiences that don't transfer to daily life","Emotional intensity mistaken for depth"],
    plainSigns:["Repeated intense experiences without lasting change","Seeking increasingly dramatic approaches","'Breakthrough' experiences that don't transfer to daily life","Emotional intensity mistaken for depth"],
    antidote:"Slow down. Add titration, pacing, and integration time. Work with modalities that emphasize settling after activation and meaning-making after release.",
    dims:["completion","affect"],risk:["biocore","istdp","holo","plant","men","rhythms"]},
  {name:"Healing as Identity",
    desc:"'Doing my work' becomes a new fixed self-structure. The ego co-opts the healing process as its latest project.",
    looks:"Your healing journey is a central part of how you introduce yourself. You evaluate others by whether they're 'doing their work.' There's a spiritual résumé accumulating. The process that was supposed to dissolve fixed identity has become one.",
    signs:["Competitive healing — comparing depth of work","Social identity organized around being 'in process'","Difficulty being ordinary or not-special","Using healing vocabulary as social currency"],
    antidote:"Notice the one who's 'doing the work.' That one is also a construction. Humor helps. Ordinariness helps. Relationships with people who don't share your framework help.",
    dims:["identity"],risk:["step12","plant","men"]},
  {name:"Insufficient Ground",
    desc:"Going into deep material without enough nervous system capacity or relational holding. The system opens faster than it can integrate.",
    looks:"You did a powerful retreat, ceremony, or intensive and came back destabilized. Sleep disrupted, anxiety spiking, intrusive material you can't contain. Or you're chronically activated — doing deep work but never feeling settled.",
    signs:["Chronic dysregulation masked as 'processing'","Flashbacks or intrusions after deep work","Can't function normally between sessions","Feeling worse over time, not better"],
    plainSigns:["Constant overwhelm disguised as 'processing'","Flashbacks or intrusive memories after deep work","Can't function normally between sessions","Feeling worse over time, not better"],
    antidote:"Stop going deeper and start building ground. Resourcing, titration, co-regulation, nervous system capacity. You need a bigger container before adding more material.",
    dims:["capacity"],risk:["plant","istdp","holo","fam","kundy","vision","ket"]},
  {name:"Chemical Shortcut",
    desc:"Using substances to access states the organism hasn't built the capacity to sustain. The medicine opens the door but you can't hold what walks through.",
    looks:"Profound experiences in ceremony or session — genuine contact with deep material. But you can't access those states sober, and the insights don't metabolize into your daily life. You start needing the medicine to feel anything at all.",
    signs:["Integration between sessions feels flat or impossible","Increasing frequency or dose","Spiritual experiences that don't transfer to relationships","Using medicine to avoid the slow work"],
    antidote:"Space ceremonies far apart. Invest heavily in integration practices between sessions. Build the sober capacity to contact what the medicine showed you.",
    dims:["capacity","energetic"],risk:["plant","ket","holo"]},
  {name:"Technique Accumulation",
    desc:"Collecting modalities without deepening in any. Breadth substituting for the vulnerability of commitment.",
    looks:"You've tried everything — breathwork, IFS, somatic work, plant medicine, circling, meditation. You know the vocabulary of twelve traditions. But you haven't gone truly deep in any of them, because going deep means staying with what's uncomfortable.",
    signs:["New modality every few months","Expertise in describing modalities, not in being changed by them","Shopping for the 'right' approach as avoidance","'I've tried that' about everything"],
    plainSigns:["New approach every few months","Good at describing different practices, but not changed by any of them","Shopping for the 'right' one as a way of avoiding depth","'I've tried that' about everything"],
    antidote:"Pick two or three and commit for a sustained period. Depth comes from staying, not from sampling. The modality that irritates you or bores you might be the one that would actually reach you.",
    dims:["models","diff"],risk:[]},
  {name:"Relational Avoidance",
    desc:"Doing all your work solo or in one-on-one settings. Avoiding the vulnerability of being seen by peers.",
    looks:"You have a meditation practice, a therapist, maybe bodywork. All private, all controlled. The idea of a men's group, a 12-step meeting, or circling makes you uncomfortable — which is precisely the signal.",
    signs:["Resistance to group formats","Healing work is private and controlled","Comfort with practitioner but not peer vulnerability","Relational patterns unchanged despite deep individual work"],
    antidote:"Your relational patterns formed in relationship and can only fully update in relationship. Join something where you'll be seen imperfectly by people who aren't paid to hold you.",
    dims:["ground"],risk:["se","emdr","nfb","float","maha","vip"]},
  {name:"Shadow Avoidance",
    desc:"Doing genuine deep work while systematically avoiding the split-off material. You heal what's stuck but never touch what's banished.",
    looks:"Your practice is real — you've done body work, felt deep feelings, updated old patterns. But there are territories you've never entered: the rage you won't own, the desire you've transcended, the selfishness beneath your generosity. The work circles around the forbidden zones.",
    signs:["'I don't really feel anger' from someone with visible tension","Healing that never touches sexuality, power, or aggression","Others see qualities in you that you can't recognize","Persistent projection — 'they're the problem, not me'"],
    antidote:"Go to exactly the places your system has organized itself to avoid. Existential kink, shadow-oriented IFS, Jungian work, honest group feedback. Ask the people closest to you what they see that you don't.",
    dims:["shadow"],risk:["se","cbt","nfb","dbt","act","tre","emdr"]},
];

const ZONE_C = {Ground:C.gnd,Foundation:C.acc,Body:C.som,"Body → Psyche":C.som,Psyche:C.psy,"Identity / Existential":C.idn,"Subtle Body":C.eng,Wholeness:C.shd};

/* ━━ Diagnostic / Compass data ━━ */
const COMPASS = {
  capacity:{
    q:"Do I have enough ground under me right now?",
    body:"Notice your breath. Is it shallow and high in the chest? Do you feel a baseline hum of anxiety, or a settled weight in your belly? Can you feel your feet?",
    stuck:"You know you need to go deeper but every attempt leaves you more activated, not more integrated. Sleep is disrupted. You can't settle after sessions. The work feels like it's making things worse.",
    invite:"This isn't a sign of failure — it's information. Your container needs to grow before more material can safely emerge. Building capacity isn't avoiding the work; it's making the work possible.",
    keys:["Chronic activation or numbness between sessions","Can't settle after deep work","Feeling worse over time, not better","Startle response still high"],
  },
  completion:{
    q:"Is my body holding something it never got to finish?",
    body:"Scan for bracing — jaw, shoulders, fists, pelvic floor. Is there a push that was never pushed, a run that was never run? Do your hands want to do something your mind won't let them?",
    stuck:"You understand your patterns intellectually but your body hasn't caught up. Tension persists despite insight. You freeze or brace in situations that aren't actually dangerous. The body is still living in the old scene.",
    invite:"The body doesn't care about your insights. It needs to finish what it started — not dramatically, but at its own pace, with titration and support. Completion is not catharsis; it's the body arriving somewhere new.",
    keys:["Persistent physical tension with no medical cause","Freeze or fawn responses in safe situations","Knowing something is safe but body says otherwise","Incomplete gestures — wanting to push, run, or scream"],
  },
  affect:{
    q:"Am I willing to feel what I haven't felt yet?",
    body:"What emotion is just underneath the surface right now? Not the one you're comfortable naming, but the one below that. Is there grief under your anger? Terror under your numbness? Longing under your self-sufficiency?",
    stuck:"You can talk about your feelings but you don't quite feel them — or you feel the acceptable ones while the deeper layer stays frozen. There's a sense of something waiting, something the system won't let through yet.",
    invite:"Metabolization isn't dramatic. It's staying with a wave of feeling without acting it out, analyzing it away, or transcending it. Thirty seconds of genuine contact with unfelt grief changes more than a year of talking about it.",
    keys:["Talking about feelings without the body responding","Same emotions recycling without deepening","'I should feel sad but I don't'","Numbness or flatness where feeling should be"],
  },
  diff:{
    q:"Can I tell what's past from what's present?",
    body:"When you're activated — in a conflict, a trigger, a wave of feeling — can you notice: 'this is the child's experience, not my adult reality'? Or does the past flood the present completely?",
    stuck:"You react to current situations with the intensity of old ones. Your partner becomes your parent. A colleague's criticism becomes childhood rejection. You know this is happening but can't stop it in the moment.",
    invite:"Differentiation isn't suppression — it's expanding your awareness to hold both realities at once. 'Yes, I feel abandoned AND I can see that this person just needed space.' The 'and' is everything.",
    keys:["Reactions disproportionate to the situation","Can't distinguish triggered state from current reality","'I know it's not rational but...'","Fusing with parts, emotions, or stories"],
  },
  models:{
    q:"Am I having new experiences, or re-enacting old ones?",
    body:"Think of a recent relationship moment that felt charged. Did something new actually happen — or did you maneuver the situation to confirm what you already believed? Did you let yourself be surprised?",
    stuck:"You keep creating the same relational outcome despite understanding the pattern. You choose partners who confirm your predictions. You behave in ways that make your fears come true. Insight hasn't changed the loop.",
    invite:"Predictions don't update through understanding — they update through experience. The old belief has to be active, met with something genuinely different, and you have to be present enough to notice the mismatch. This is why relationships are the laboratory.",
    keys:["Same relational pattern across different people","Self-fulfilling prophecies you can see but not stop","Insight that doesn't change behavior","Choosing safety over the discomfort of newness"],
  },
  identity:{
    q:"Am I holding onto a self-structure that's ready to dissolve?",
    body:"Who are you in your healing work? The strong one? The wounded one? The helper? The seeker? Feel into that identity — does it still fit, or is it starting to feel like a costume?",
    stuck:"You've done real work but you've built a new identity around it. 'The person who's been through a lot.' 'The one who does deep work.' The self-structure has updated but it's still a structure — and it's starting to feel tight.",
    invite:"Identity reorganization can't be forced — it happens when enough underlying material has shifted that the old structure simply can't hold. The dissolution is disorienting and often grief-filled. It's not failure; it's the fruit of everything that came before.",
    keys:["New identity built around healing or growth","Resistance to being ordinary or undefined","Spiritual or therapeutic identity feels limiting","Sense of 'who am I if not this?'"],
  },
  energetic:{
    q:"Am I attending to what's subtler than emotion and coarser than thought?",
    body:"Close your eyes. Can you sense the quality of aliveness in different parts of your body — not muscular tension, not emotion, but something more like current, or density, or space? Places that feel open versus places that feel stuck or dark?",
    stuck:"You've done psychological and somatic work but something doesn't quite shift. There's a quality to the stuckness that's below the level of parts or emotions — more like a channel that's blocked, an area of the body that's energetically dead or congested.",
    invite:"This dimension requires a different quality of attention — softer, more receptive, less goal-oriented. It often responds to practices your rational mind dismisses. That dismissal itself may be worth examining.",
    keys:["Stuckness that doesn't respond to psychological or somatic work","Sense of energetic congestion or deadness in specific areas","Strong responses to acupuncture, breathwork, or qigong","Subtle body phenomena you can't explain in psychological terms"],
  },
  shadow:{
    q:"What have I exiled from my self-experience?",
    body:"Think of a quality you really dislike in others — selfishness, neediness, aggression, manipulation. Now ask: where does that live in me? Notice what your body does with that question. The flinch IS the data.",
    stuck:"Your work is genuine but it circles around certain territories. You heal the acceptable wounds and leave the forbidden ones untouched. You've become more compassionate but never contacted your cruelty. More vulnerable but never owned your power. More spiritual but never faced your hunger.",
    invite:"Shadow work isn't about becoming your worst fear — it's about ending the war against parts of yourself. What you banish doesn't disappear; it runs your life from the basement. Welcoming it home doesn't make you dangerous. It makes you whole.",
    keys:["Strong reactions to qualities in others that you can't see in yourself","'I'm not an angry person' with visible tension","Healing that avoids sexuality, power, aggression, or selfishness","Others consistently see things in you that you can't recognize"],
  },
};

/* ━━ Plain language alternatives ━━ */
const PLAIN = {
  // Dimension short descriptions
  "ground.short":"The quality of connection that makes all other healing possible",
  "capacity.short":"Building the ability to handle difficult feelings without being overwhelmed",
  "completion.short":"Letting the body finish reactions it had to shut down",
  "affect.short":"Gradually feeling emotions that were too much to feel before",
  "diff.short":"Learning to tell old reactions apart from what's happening now",
  "models.short":"Updating deep beliefs through new experiences, not just understanding",
  "identity.short":"Allowing old versions of 'who I am' to shift and change",
  "energetic.short":"Working with subtle body sensations that don't fit neatly into emotions or thoughts",
  "shadow.short":"Reclaiming the parts of yourself you've rejected or hidden away",

  // Dimension full descriptions
  "ground.desc":"Healing doesn't happen in isolation — it happens in connection. The quality of the relationship you're in during the work (with a therapist, a group, a partner, even yourself) determines whether real change happens or you're just going through the motions.",
  "capacity.desc":"Before you can safely explore painful material, your nervous system needs to be able to handle it. This means learning to calm yourself down, having people you feel safe with, and being able to move between feeling activated and feeling settled. This isn't a one-time thing — you need more capacity as you go deeper.",
  "completion.desc":"When something overwhelming happened, your body may have started to fight back, run, freeze up, or shut down — but couldn't finish. Those incomplete reactions are still stored in your body. Healing here means safely letting those responses complete. This is different from just venting — real completion leaves you feeling genuinely settled in a new way.",
  "affect.desc":"As the body releases, buried emotions come up — grief hiding under anger, fear hiding under numbness, longing hiding under independence. Healing here means staying present with feelings without acting on them, analyzing them, or pushing past them. It happens in waves, at its own pace.",
  "diff.desc":"Learning to tell the difference between then and now, between a feeling and the story about it, between a part of you and all of you. 'This is my five-year-old's fear, not my adult reality.' Without body and emotional work first, this just stays in your head.",
  "models.desc":"Deep down, your nervous system carries beliefs formed during hard times: 'people always leave,' 'I'm too much,' 'I have to earn love.' These only change when the old belief gets activated AND something genuinely different happens AND you notice the difference. This is why just understanding your patterns isn't enough — you need new experiences.",
  "identity.desc":"As enough old beliefs update, the sense of self they held together starts to shift. 'The strong one,' 'the wounded one,' 'the caretaker' — these identities start feeling less solid. This can't be rushed. It happens naturally when enough has shifted underneath. Trying to force it leads to pretending rather than real change.",
  "energetic.desc":"Sometimes there are shifts happening in the body that are subtler than muscle tension but more physical than emotions or thoughts. Different traditions call these energy, qi, prana, or describe channels and centers in the body. This dimension has its own timing and sometimes moves independently of the other work.",
  "shadow.desc":"The other dimensions deal with things that are stuck. This one deals with things you've actively pushed away — parts of yourself you've decided are unacceptable. The mechanism isn't releasing or processing but welcoming back what was rejected. At every level of healing, there are things that were forbidden, not just unfelt. Full healing means going to exactly those places.",

  // Theory tab
  "theory.trauma.1":"When something overwhelming happens, your mind and body do smart things to survive — you might freeze, shut down, people-please, or disconnect. The problem is that those survival strategies keep running even when you're safe now. They live in your body as tension and bracing, in your mind as beliefs like 'people can't be trusted,' and in your sense of self as rigid stories about who you are.",
  "theory.trauma.2":"Healing means making contact with what you couldn't handle at the time, and letting it finally be processed. You're not broken — something got interrupted, and it needs to be completed.",
  "theory.dims":"Rather than a step-by-step process, healing works across nine different areas at once — seven that build on each other in a natural order, plus two that weave through everything. Each area has different tools that work best, and different ways of getting stuck.",
  "theory.spiral.1":"There's a natural order — you need to feel safe enough before going deep, body work comes before deep emotional work, telling old feelings from current ones helps you update old beliefs — but the process spirals rather than climbs. Each time around, you go deeper as new material becomes available from a more stable foundation.",
  "theory.spiral.2":"These areas aren't really separate — a body sensation IS an emotion IS a belief IS a relationship pattern, all at once. It matters less where you start than how fully you show up.",
  "theory.modality.1":"Every healing approach is good at some things and limited at others. Body-based work is great at releasing physical tension but doesn't directly change your beliefs about relationships. Meditation develops deep awareness but can leave relationship patterns untouched. Talking helps you understand patterns but rarely releases a physical survival response.",
  "theory.modality.2":"This tool maps over 50 different approaches across all nine areas, showing what each one is good at and what it misses. The goal isn't to try everything — it's to see clearly what your current practice covers and where the gaps are.",
  "theory.shadow.1":"You can do real healing work in every other area while avoiding the things you've truly rejected about yourself. You can release safe body tensions while the forbidden impulses stay frozen. You can feel acceptable emotions while the scary ones stay locked away.",
  "theory.shadow.2":"Shadow work feels different from other healing — it's not about finishing something that got interrupted, but about welcoming back something that was kicked out. The anger the 'nice person' won't own. The vulnerability the 'strong one' has walled off. The desire the 'spiritual one' has risen above. Wholeness means nothing left out of who you are.",
  "theory.compass.1":"When healing feels stuck, the most useful question is: what am I avoiding? The area you least want to look at is usually the one you most need. The body worker who never does group work. The meditator who never lets themselves feel. The therapy client who never lets their body move. The ceremony-goer who never does the slow daily work.",
  "theory.compass.2":"Use the other tabs to see the full framework, check your own program for gaps, understand common pitfalls, and find where you might be stuck.",

  // Theory dimension list
  "theory.ground":"Healing happens in connection. Whether someone is truly present and attuned with you determines whether anything really changes or you're just going through motions. Your deepest wounds formed in relationship; they heal in relationship.",
  "theory.capacity":"Your nervous system needs to be stable enough to handle what comes up. This means being able to calm yourself (internally) and having safe people around you (externally). This isn't something you check off — as you go deeper, you need more stability.",
  "theory.completion":"Your body holds reactions it never got to finish — hands that wanted to push, legs that wanted to run, a chest that wanted to open. Completion means safely letting those responses happen. Different from dramatic release — real completion leaves you feeling settled in a genuinely new way.",
  "theory.affect":"As your body releases, buried feelings surface — grief under anger, fear under numbness, longing under self-sufficiency. Healing here means staying with those feelings without acting on them, explaining them away, or trying to rise above them. A slow digestion that comes in waves.",
  "theory.diff":"'This is the child's fear, not my adult reality.' Telling apart past from present, a part of you from all of you, a feeling from the story about it. Without body and emotional work first, this becomes just intellectual understanding.",
  "theory.models":"Your nervous system carries beliefs from hard times: 'people leave,' 'I'm too much.' These change only when the belief gets activated, something genuinely different happens, and you notice. Understanding alone doesn't heal — new experience is what changes things.",
  "theory.identity":"As enough beliefs update, the identity built on them starts to dissolve. 'The wounded one,' 'the strong one,' 'the helper' — loosening. Can't be forced; happens when enough has shifted underneath. Trying too early creates pretending rather than real transformation.",
  "theory.energetic":"Subtler than muscle tension, more physical than emotions or thoughts. Traditional systems describe energy channels, centers, and flows. This area has its own rhythm — sometimes it moves first, sometimes last, sometimes it's the catalyst. Needs a soft, open quality of attention.",
  "theory.shadow":"Other areas work with what's stuck. This one works with what you've actively rejected — pushed out of your sense of self. The mechanism isn't releasing or processing but welcoming back what was exiled. At every level, there are things that were forbidden, not just unfelt. Real wholeness means going to exactly the places you've organized your life to avoid.",

  // Compass/diagnostic
  "compass.capacity.q":"Do I feel stable enough for what's coming up?",
  "compass.capacity.body":"Notice your breathing. Is it shallow and tight in your chest? Do you feel a background buzz of anxiety, or a settled weight in your belly? Can you feel your feet on the floor?",
  "compass.capacity.stuck":"You know you need to go deeper but every time you try, you end up more rattled, not more healed. Sleep gets worse. You can't calm down between sessions. The work feels like it's making things worse.",
  "compass.capacity.invite":"This isn't failure — it's useful information. Your container needs to get bigger before more can safely surface. Building stability isn't avoiding the real work; it's what makes the real work possible.",
  "compass.completion.q":"Is my body still holding onto something it never got to finish?",
  "compass.completion.body":"Scan for bracing — jaw, shoulders, fists, pelvic floor. Is there a push that never got pushed, a run that never got run? Do your hands want to do something your mind won't allow?",
  "compass.completion.stuck":"You understand your patterns in your head but your body hasn't caught up. Tension persists despite insight. You freeze up in safe situations. Your body is still living in the old scene.",
  "compass.completion.invite":"Your body doesn't care about your insights. It needs to finish what it started — not dramatically, but at its own pace. Completion isn't venting; it's the body arriving somewhere genuinely new.",
  "compass.affect.q":"Am I willing to feel what I haven't felt yet?",
  "compass.affect.body":"What emotion is just below the surface right now? Not the one you can easily name, but the one underneath that. Is there sadness under your anger? Fear under your numbness? Longing under your independence?",
  "compass.affect.stuck":"You can talk about your feelings but don't quite feel them in your body — or you feel the easy ones while the deeper layer stays locked. Something is waiting that your system won't let through yet.",
  "compass.affect.invite":"Processing emotions isn't dramatic. It's staying with a wave of feeling without acting on it, explaining it away, or rising above it. Thirty seconds of genuinely feeling unfelt grief changes more than a year of talking about it.",
  "compass.diff.q":"Can I tell the difference between what's old and what's now?",
  "compass.diff.body":"When you're triggered — in a fight, a panic, a wave of feeling — can you notice: 'this is the child's experience, not what's actually happening now'? Or does the past completely flood the present?",
  "compass.diff.stuck":"You react to current situations with the intensity of old ones. Your partner becomes your parent. A coworker's feedback becomes childhood rejection. You can see it happening but can't stop it.",
  "compass.diff.invite":"This isn't about suppressing reactions — it's about growing your awareness to hold both realities. 'Yes, I feel abandoned AND I can see this person just needed space.' The 'and' is everything.",
  "compass.models.q":"Am I having genuinely new experiences, or repeating old patterns?",
  "compass.models.body":"Think of a recent relationship moment that felt charged. Did something new happen — or did you steer things to confirm what you already believed? Did you let yourself be surprised?",
  "compass.models.stuck":"You keep ending up in the same situations despite understanding the pattern. You choose people who confirm your fears. You act in ways that make your worst predictions come true. Understanding hasn't broken the loop.",
  "compass.models.invite":"Old beliefs don't change through understanding — they change through experience. The belief has to be active, something genuinely different has to happen, and you have to be present enough to notice. This is why relationships are where the real work happens.",
  "compass.identity.q":"Am I holding onto a version of myself that's ready to change?",
  "compass.identity.body":"Who are you in your healing journey? The strong one? The wounded one? The helper? The seeker? Feel into that identity — does it still fit, or is it starting to feel like a costume?",
  "compass.identity.stuck":"You've done real work but built a new identity around it. 'The person who's been through a lot.' 'The one who does deep work.' Your sense of self has updated but it's still rigid — and it's starting to feel tight.",
  "compass.identity.invite":"Identity change can't be forced — it happens when enough has shifted underneath that the old structure can't hold. It's disorienting and often brings grief. It's not failure; it's the natural result of all the work you've done.",
  "compass.energetic.q":"Am I paying attention to what's subtler than emotion but more physical than thought?",
  "compass.energetic.body":"Close your eyes. Can you sense the quality of aliveness in different areas of your body — not muscle tension, not emotion, but something more like a current, or heaviness, or spaciousness? Places that feel open vs. places that feel stuck?",
  "compass.energetic.stuck":"You've done psychological and body work but something won't shift. There's a quality to the stuckness below the level of feelings or stories — more like a channel that's blocked, an area that feels dead or congested.",
  "compass.energetic.invite":"This area needs a different kind of attention — softer, more open, less goal-driven. It often responds to practices your rational mind dismisses. That dismissal itself might be worth looking at.",
  "compass.shadow.q":"What have I rejected about myself?",
  "compass.shadow.body":"Think of a quality you really dislike in other people — selfishness, neediness, aggression, manipulation. Now ask: where does that live in me? Notice what your body does with that question. The flinch IS the information.",
  "compass.shadow.stuck":"Your work is genuine but it circles around certain topics. You heal the acceptable stuff and leave the forbidden stuff alone. You've become more compassionate but never faced your cruelty. More open but never owned your power. More spiritual but never looked at your hunger.",
  "compass.shadow.invite":"Shadow work isn't about becoming your worst fear — it's about ending the war against parts of yourself. What you reject doesn't disappear; it runs your life from underground. Welcoming it back doesn't make you dangerous. It makes you whole.",

  // Traps
  "trap.0.desc":"Using spiritual practices to avoid dealing with difficult feelings. Rising above becomes a way to not feel.",
  "trap.0.looks":"You can talk about your patterns clearly. You have a real meditation practice and genuine experiences of inner peace. But your body is still tense, your relationships still hit the same walls, and there's a subtle sense of being 'above' people who are more emotional.",
  "trap.0.antidote":"Add body-based and group work. Let yourself not know. Let someone see you fall apart. You have to build the ground floor, not skip over it.",
  "trap.1.desc":"Understanding without change. You can explain every pattern perfectly but nothing actually shifts in your life.",
  "trap.1.looks":"You've read the books, know the frameworks, can explain your relationship style and your parents' influence. Your therapist is impressed. But you're still in the same loops — you just describe them better now.",
  "trap.1.antidote":"Move from talking about experience to actually having it. Body work, group work, anything that puts you in direct contact with what you've been describing from a safe distance.",
  "trap.2.desc":"Big emotional or physical releases that feel real in the moment but don't create lasting change.",
  "trap.2.looks":"You've had huge releases — shaking, crying, screaming, powerful visions. They feel like breakthroughs at the time, maybe for days after. But you keep having the same kind of release about the same stuff. Your baseline doesn't actually shift.",
  "trap.2.antidote":"Slow down. Add pacing and rest time between sessions. Work with approaches that emphasize calming down after getting activated, and making meaning after release.",
  "trap.3.desc":"'Doing my work' becomes a new rigid identity. Your ego turns the healing process into its latest project.",
  "trap.3.looks":"Your healing journey is a central part of how you introduce yourself. You judge others by whether they're 'doing their work.' There's a spiritual résumé building up. The process that was supposed to make you more flexible has become another fixed thing.",
  "trap.3.antidote":"Notice the one who's 'doing the work.' That one is also a construction. Humor helps. Being ordinary helps. Spending time with people who don't share your framework helps.",
  "trap.4.desc":"Going into deep stuff without enough stability or support. Things open faster than they can be handled.",
  "trap.4.looks":"You did a powerful retreat or ceremony and came back rattled. Sleep disrupted, anxiety spiking, stuff coming up you can't contain. Or you're always activated — doing deep work but never actually feeling settled.",
  "trap.4.antidote":"Stop going deeper and start building a foundation. Calming practices, safe relationships, nervous system stability. You need a bigger container before pouring in more material.",
  "trap.5.desc":"Using substances to reach states you haven't built the ability to hold on to. The medicine opens the door but you can't handle what walks through.",
  "trap.5.looks":"Real experiences in ceremony — genuine contact with deep material. But you can't access those states without the substance, and the insights don't stick in daily life. You start needing the medicine to feel anything.",
  "trap.5.antidote":"Space sessions far apart. Invest heavily in daily integration. Build the everyday ability to contact what the medicine showed you.",
  "trap.6.desc":"Trying lots of different approaches without going deep in any. Collecting experiences instead of being changed by them.",
  "trap.6.looks":"You've tried everything — breathwork, therapy, plant medicine, meditation, group work. You know the language of a dozen traditions. But you haven't gone truly deep in any, because going deep means staying with discomfort.",
  "trap.6.antidote":"Pick two or three and commit for a sustained period. Depth comes from staying, not sampling. The approach that bores or irritates you might be the one that could actually reach you.",
  "trap.7.desc":"Doing all your work alone or one-on-one. Avoiding being truly seen by peers.",
  "trap.7.looks":"You have a meditation practice, a therapist, maybe bodywork. All private, all controlled. The idea of a group setting makes you uncomfortable — which is exactly the signal.",
  "trap.7.antidote":"Your relationship patterns formed in relationships and can only fully change there. Join something where you'll be seen imperfectly by people who aren't paid to support you.",
  "trap.8.desc":"Doing genuine deep work while always going around the stuff you've truly rejected about yourself.",
  "trap.8.looks":"Your practice is real — you've done body work, felt deep feelings, changed old patterns. But there are areas you've never entered: the anger you won't own, the desire you've risen above, the selfishness beneath your generosity. The work circles around those zones.",
  "trap.8.antidote":"Go to exactly the places you've organized your life to avoid. Shadow-oriented therapy, honest group feedback. Ask the people closest to you what they see that you don't.",
};

const LVL_C = {strong:C.strong,moderate:C.moderate,weak:C.weak,none:C.none};
const LVL_L = {strong:"Strong",moderate:"Moderate",weak:"Weak",none:"Gap"};

/* ━━ Assessment logic ━━ */
function assess(sel, activeConds) {
  // Build condition tier map: modId → best tier (1=essential, 5=contraindicated)
  const condTier = {};
  const condDimW = {};
  if(activeConds && activeConds.size > 0) {
    activeConds.forEach(cId => {
      const cond = COND_MAP[cId];
      if(!cond) return;
      (cond.essential||[]).forEach(id => { if(!condTier[id] || condTier[id] > 1) condTier[id] = 1; });
      (cond.recommended||[]).forEach(id => { if(!condTier[id] || condTier[id] > 2) condTier[id] = 2; });
      (cond.helpful||[]).forEach(id => { if(!condTier[id] || condTier[id] > 3) condTier[id] = 3; });
      (cond.caution||[]).forEach(id => { if(!condTier[id] || condTier[id] > 4) condTier[id] = 4; });
      (cond.contraindicated||[]).forEach(id => { condTier[id] = 5; }); // contraindicated always wins
      Object.entries(cond.dimWeights).forEach(([dId, w]) => {
        condDimW[dId] = (condDimW[dId]||0) + w;
      });
    });
  }
  const hasConds = activeConds && activeConds.size > 0;

  // Condition-aware scoring multipliers per tier
  // essential=1.5x, recommended=1.2x, helpful=1.0x, caution=0.3x, contraindicated=-0.5x
  const tierMult = {1:1.5, 2:1.2, 3:1.0, 4:0.3, 5:-0.5};

  const results = DIMS.map(dim => {
    // Dimension importance multiplier from conditions
    const dimImportance = hasConds && condDimW[dim.id] ? (1 + condDimW[dim.id] * 0.15) : 1;

    let rawScore = 0;
    const eMatch = []; const pMatch = []; const harmMatch = [];

    (dim.eff||[]).filter(m => sel.has(m.id)).forEach(m => {
      const t = condTier[m.id] || 0;
      const mult = (hasConds && t) ? tierMult[t] : 1;
      if(mult < 0) {
        rawScore += 28 * mult; // negative contribution
        harmMatch.push(m.name);
      } else {
        rawScore += 28 * mult;
        eMatch.push(m.name);
      }
    });
    (dim.par||[]).filter(m => sel.has(m.id)).forEach(m => {
      const t = condTier[m.id] || 0;
      const mult = (hasConds && t) ? tierMult[t] : 1;
      if(mult < 0) {
        rawScore += 10 * mult;
        harmMatch.push(m.name);
      } else {
        rawScore += 10 * mult;
        pMatch.push(m.name);
      }
    });

    // Apply dimension importance scaling
    const score = Math.max(0, Math.min(100, Math.round(rawScore * dimImportance)));
    const level = score >= 56 ? "strong" : score >= 28 ? "moderate" : score > 0 ? "weak" : "none";
    return {dim, score, level, eMatch, pMatch, harmMatch, dimImportance};
  });

  const trapRisks = TRAPS.map(t => {
    const gaps = t.dims.filter(dId => {const r=results.find(x=>x.dim.id===dId); return !r||r.level==="none"||r.level==="weak";});
    const hasRisk = t.risk.some(id => sel.has(id));
    const risk = gaps.length > 0 && hasRisk ? "high" : gaps.length > 0 || hasRisk ? "moderate" : "low";
    return {...t, risk, gaps};
  });

  return {results, trapRisks};
}

/* ━━ Recommendation engine ━━ */
// Modality categories for complementarity analysis
const MOD_CATS = {
  body:["se","sm","biocore","tre","rolf","feld","cranio","massage","yoga","kundy","taichi","martial","ci","rhythms","acu"],
  psyche:["ifs","gestalt","talk","cbt","dbt","act","jung","psychodyn","istdp","emdr","hakomi","emres","nlp","hypno","art","music","drama"],
  relational:["step12","men","rc","circ","nvc","eft","grpther","fam","cuddle","forum","hoop"],
  contemplative:["maha","vip","zen","dzog","adv","real","cenpr","sufi","kirtan","hrid"],
  altered:["plant","holo","wimhof","ket","float"],
  nature:["nature","vision","sweat"],
  tech:["nfb","vns"],
};

const CAT_LABELS = {body:"Body-Based",psyche:"Psychotherapeutic",relational:"Relational / Community",contemplative:"Contemplative / Spiritual",altered:"Altered States",nature:"Nature / Ceremony",tech:"Technology-Assisted"};

const MOD_INFO = {
  se:{desc:"Tracks body sensations to complete thwarted survival responses. Works with pendulation (oscillating between activation and settling), titration (small doses), and resourcing. The gold standard for trauma resolution — lets the body finish what it started.",plain:"Works with body sensations to gently help your nervous system complete stress responses that got stuck. Goes slowly, builds safety first.",url:"https://www.somaticexperiencing.com",urlLabel:"Somatic Experiencing International"},
  ifs:{desc:"Maps the psyche as a system of parts — protectors (managers, firefighters) and exiles (wounded parts carrying burdens). Healing occurs when Self-energy witnesses and unburdons exiled parts. Non-pathologizing: all parts have positive intent.",plain:"Works with the different 'parts' of you — the protectors, the wounded parts, the wise center. Helps each part feel seen and let go of old burdens.",url:"https://ifs-institute.com",urlLabel:"IFS Institute"},
  gestalt:{desc:"Emphasizes present-moment awareness, direct experience, and contact. Techniques include empty chair dialogue, body tracking, polarities work, and experiments. The I-Thou relationship between therapist and client is central. Powerful for affect and shadow.",plain:"Focuses on what's happening right now — your feelings, your body, your contact with others. Uses creative exercises like talking to an empty chair to access buried emotions.",url:"https://www.gestalttherapy.org",urlLabel:"Association for Advancement of Gestalt Therapy"},
  sm:{desc:"Integrates body-oriented interventions with cognitive and emotional processing. Tracks sensorimotor sequences — sensation, image, behavior, affect, meaning (SIBAM). Bridges somatic and psychological work more explicitly than SE.",plain:"Combines body awareness with understanding what your experiences mean. Tracks how sensations, images, feelings, and meanings all connect.",url:"https://www.sensorimotorpsychotherapy.org",urlLabel:"Sensorimotor Psychotherapy Institute"},
  biocore:{desc:"Works directly with muscular armoring — chronic tension patterns that hold repressed emotion and life force. Grounding, breathing, and expressive exercises release bound energy. Powerful for depression, collapse, and frozen affect.",plain:"Uses physical exercises to release emotional energy trapped in chronic muscle tension. Especially powerful for depression — gets frozen energy moving.",url:"https://www.coreenergetics.org",urlLabel:"Institute of Core Energetics"},
  rc:{desc:"Peer counseling model where partners take equal turns giving and receiving attention. Discharge (crying, trembling, laughing, raging, yawning) is the mechanism of healing. Based on the premise that humans are inherently intelligent and that distress creates rigid patterns.",plain:"A peer-based practice where two people take turns listening to each other. Emotional release — crying, shaking, laughing — is how healing happens.",url:"https://www.rc.org",urlLabel:"Re-evaluation Counseling"},
  tre:{desc:"Neurogenic tremoring — activating the body's natural shaking response to release deep muscular tension. Self-directed after initial instruction. Simple, accumulative, accessible. Works below conscious control.",plain:"Activates your body's natural shaking mechanism to release deep tension. Simple exercises you can do on your own once you learn them.",url:"https://traumaprevention.com",urlLabel:"TRE for All"},
  men:{desc:"Gender-specific group work emphasizing vulnerability, confrontation, accountability, and initiation. The group becomes a crucible where shadow material surfaces through peer witnessing. Powerful for shame, isolation, and relational avoidance.",plain:"Groups where men (or women) practice being vulnerable together, hold each other accountable, and witness each other's struggles. Breaks isolation and surfaces hidden parts of yourself.",url:"https://mankindproject.org",urlLabel:"ManKind Project"},
  talk:{desc:"Unstructured verbal processing with a therapist. Useful for narrative coherence and feeling heard, but limited in accessing body-level material, implicit memories, and deeply held beliefs. Often where people start.",plain:"Traditional therapy — talking through your experiences with a therapist. Good for feeling heard and understood, but limited in reaching the body or deep unconscious patterns.",url:"https://www.apa.org/topics/psychotherapy",urlLabel:"American Psychological Association"},
  cbt:{desc:"Identifies and restructures maladaptive thought patterns. Strong evidence base for anxiety and depression symptoms. Works at the cognitive level — limited effectiveness for trauma, attachment, and body-held material.",plain:"Helps you notice and change unhelpful thinking patterns. Well-researched for anxiety and depression symptoms, but works mostly at the thinking level.",url:"https://www.beckinstitute.org",urlLabel:"Beck Institute for CBT"},
  dbt:{desc:"Developed for borderline personality and emotional dysregulation. Four modules: mindfulness, distress tolerance, emotion regulation, interpersonal effectiveness. Teaches skills for surviving intense affect without destructive behavior.",plain:"Teaches practical skills for handling intense emotions — how to tolerate distress, regulate feelings, and navigate relationships without things falling apart.",url:"https://behavioraltech.org",urlLabel:"Behavioral Tech (Marsha Linehan)"},
  act:{desc:"Third-wave behavioral therapy emphasizing psychological flexibility. Six core processes: defusion, acceptance, present moment, self-as-context, values, committed action. Cognitive but less pathologizing than CBT.",plain:"Focuses on accepting difficult thoughts and feelings while committing to actions aligned with your values. Less about 'fixing' thinking, more about flexibility.",url:"https://contextualscience.org",urlLabel:"Association for Contextual Behavioral Science"},
  jung:{desc:"Depth psychology working with archetypes, shadow, anima/animus, and the individuation process. Active imagination, dream analysis, and symbolic amplification. Slow, deep, transformative when held over years.",plain:"Deep work with dreams, symbols, and the hidden parts of your psyche. Explores your shadow, your inner masculine/feminine, and your path toward wholeness.",url:"https://www.jungiansociety.org",urlLabel:"Jungian Society"},
  psychodyn:{desc:"Working with transference, unconscious patterns, and developmental history. The therapeutic relationship becomes the laboratory where old patterns play out and can be met differently. Slow but genuine depth.",plain:"Explores how your past relationships shape your present patterns, using the relationship with your therapist as a live laboratory for change.",url:"https://www.apsa.org",urlLabel:"American Psychoanalytic Association"},
  istdp:{desc:"Intensive short-term technique that deliberately increases emotional pressure to break through defenses to core affect. Powerful but confrontational — contraindicated for fragile systems, dissociation, and active addiction.",plain:"An intensive approach that pushes through emotional defenses quickly. Can be powerful but is too confrontational for many conditions — not for fragile systems.",url:"https://istdp.com",urlLabel:"ISTDP Institute"},
  emdr:{desc:"Uses bilateral stimulation (eye movements, tapping) while processing traumatic memories. Strong evidence base for PTSD. Works through memory reconsolidation — updating how traumatic memories are stored.",plain:"Uses eye movements or tapping while you recall difficult memories, helping your brain reprocess and store them differently. Strong research backing for trauma.",url:"https://www.emdr.com",urlLabel:"EMDR International Association"},
  hakomi:{desc:"Mindfulness-based somatic psychotherapy. Uses mindful self-study, nonviolence, and 'experiments' — small interventions that bring unconscious material into awareness. Emphasizes the 'missing experience.'",plain:"A gentle approach that uses mindful awareness and small experiments to discover what's happening below the surface. Often provides what was missing in your early experience.",url:"https://hakomiinstitute.com",urlLabel:"Hakomi Institute"},
  emres:{desc:"Emotional Resolution — tracks physical sensations connected to emotional disturbance until they naturally resolve. Brief, focused sessions. Works by completing the body's processing of unresolved emotional reactions.",plain:"Follows body sensations connected to emotional distress until they naturally resolve on their own. Brief and focused — lets the body complete its own process.",url:"https://www.emotionalhealth.institute",urlLabel:"Emotional Health Institute"},
  nlp:{desc:"Models of communication and subjective experience. Rapid reframing and anchoring techniques. Can produce quick state changes but tends to override rather than resolve underlying material. Real but often shallow.",plain:"Techniques for quickly shifting how you think and feel about experiences. Can produce fast changes, but often works at the surface rather than resolving deeper patterns.",url:"https://www.nlp.com",urlLabel:"NLP Comprehensive"},
  hypno:{desc:"Uses trance states to access subconscious material and install new suggestions. Can surface repressed memories and facilitate state changes. Therapist-directed — the client's own organism doesn't set the pace.",plain:"Uses deep relaxation and focused attention to access your subconscious mind. Can help with habits, anxiety, and accessing buried material.",url:"https://www.asch.net",urlLabel:"American Society of Clinical Hypnosis"},
  art:{desc:"Visual art-making as therapeutic process. Bypasses verbal defenses — the unconscious speaks through image, color, and form. Particularly effective for affect metabolization and shadow material.",plain:"Using art-making (drawing, painting, sculpting) to express what words can't reach. The creative process itself is healing — no artistic skill needed.",url:"https://arttherapy.org",urlLabel:"American Art Therapy Association"},
  music:{desc:"Sound, rhythm, and voice as therapeutic channels. Voice work accesses the body through the throat — a key area of held expression. Can reach grief, rage, and longing below verbal comprehension.",plain:"Using sound, singing, and rhythm to access emotions that live below words. Voice work is especially powerful for releasing held expression.",url:"https://www.musictherapy.org",urlLabel:"American Music Therapy Association"},
  drama:{desc:"Therapeutic enactment — using role-play, psychodrama, and theatrical distance to approach material that's too overwhelming in direct contact. Allows completion of thwarted responses through performance.",plain:"Using role-play and theatrical exercises to safely approach overwhelming feelings and complete experiences that got interrupted.",url:"https://www.nadta.org",urlLabel:"North American Drama Therapy Association"},
  nfb:{desc:"Directly trains brainwave patterns using real-time EEG feedback. The only modality that works directly at the neurological level. Unique mechanism — the brain learns to self-regulate through operant conditioning of its own rhythms.",plain:"Uses sensors to measure your brainwaves and gives real-time feedback so your brain learns to regulate itself. Works at the neurological level — nothing else reaches this.",url:"https://isnr.org",urlLabel:"International Society for Neuroregulation & Research"},
  circ:{desc:"Group practice of present-moment relational awareness. Participants share what they notice in real time about their own experience and others. Powerful for attachment patterns, shadow, and implicit model updating.",plain:"A group practice of sharing what you're noticing in yourself and others in real time. Reveals relationship patterns and updates how you expect people to respond to you.",url:"https://circlingeurope.com",urlLabel:"Circling Europe"},
  nvc:{desc:"Marshall Rosenberg's framework: observations, feelings, needs, requests. Creates new relational patterns through empathic listening and honest expression. Powerful communication tool — less a therapy than a relational practice.",plain:"A framework for communicating more honestly and empathically — observations without judgment, feelings, needs, and clear requests.",url:"https://www.cnvc.org",urlLabel:"Center for Nonviolent Communication"},
  eft:{desc:"Emotionally Focused Therapy for couples — restructures attachment bonds through accessing and expressing core emotions in the relationship. Based on attachment theory. Strong evidence base for couple distress.",plain:"Helps couples understand and change the emotional patterns driving their conflicts. Works directly with the attachment bond between partners.",url:"https://iceeft.com",urlLabel:"International Centre for EFT"},
  grpther:{desc:"Process-oriented group therapy where interpersonal dynamics ARE the material. The group becomes a microcosm of each member's relational world. Projection, transference, and shadow all surface in real time.",plain:"A therapy group where the relationships between group members become the focus. Your patterns with people show up live and can be worked with directly.",url:"https://www.agpa.org",urlLabel:"American Group Psychotherapy Association"},
  fam:{desc:"Bert Hellinger's systemic approach — representatives stand in for family members, revealing unconscious loyalties, entanglements, and inherited burdens. Powerful single-session format. Can surface overwhelming material.",plain:"Uses people standing in for family members to reveal hidden patterns and loyalties passed down through generations. Can surface very deep material in a single session.",url:"https://www.hellinger.com",urlLabel:"Hellinger Sciencia"},
  cuddle:{desc:"Structured, boundaried platonic touch in group or individual settings. Directly addresses touch deprivation and updates predictions about safety, vulnerability, and physical closeness.",plain:"Structured, safe, non-sexual touch practice. Heals touch deprivation and helps your nervous system learn that closeness can be safe.",url:"https://www.cuddlist.com",urlLabel:"Cuddlist"},
  forum:{desc:"Large group awareness trainings (Landmark, etc.). Intense, confrontational group process with powerful breakthroughs — but manufactured intensity and group pressure create a specific dynamic. Results may not transfer.",plain:"Intensive group seminars that use confrontation and structured exercises for breakthroughs. Can be powerful but the manufactured intensity doesn't always translate to daily life.",url:"https://en.wikipedia.org/wiki/Large-group_awareness_training",urlLabel:"Wikipedia — LGAT Overview"},
  exkink:{desc:"Carolyn Elliott's method for integrating shadow through embracing rather than rejecting unwanted experiences. Based on the insight that what we most resist, we're unconsciously attached to. Powerful for shame, identity, and shadow.",plain:"A practice of noticing what you claim to hate about your life and discovering the hidden part of you that's actually attached to it. Transforms shame into power.",url:"https://www.carolynelliott.com",urlLabel:"Carolyn Elliott"},
  step12:{desc:"12-Step programs (AA, NA, ACA, SLAA, etc.). Community, sponsorship, surrender, moral inventory, amends. The relational container — meetings, sponsor, service — is as important as the steps. Massive evidence for addiction and beyond.",plain:"Community-based programs with steps, a sponsor, meetings, and service. The ongoing relationships and structure are as important as the steps themselves. Works for addiction and much more.",url:"https://www.aa.org",urlLabel:"Alcoholics Anonymous"},
  maha:{desc:"Tibetan Buddhist practice of resting in the nature of mind. At advanced levels, all experience is recognized as the display of awareness. Shamatha (calm abiding) builds capacity; vipashyana (insight) develops differentiation. Tsa lung works with subtle body channels.",plain:"A meditation practice of learning to rest in open awareness. At its deepest, you learn to see all experience — thoughts, emotions, sensations — as expressions of awareness itself.",url:"https://tergar.org",urlLabel:"Tergar International (Mingyur Rinpoche)"},
  vip:{desc:"Systematic observation of body sensations with equanimity. Develops fine-grained differentiation between awareness and content. Powerful insight practice — risk of using equanimity to bypass unfelt emotion.",plain:"A meditation practice of carefully observing body sensations without reacting. Builds the ability to notice experience clearly, but can become a way to avoid feeling.",url:"https://www.dhamma.org",urlLabel:"Vipassana Meditation (S.N. Goenka)"},
  zen:{desc:"Direct pointing at the nature of mind through koans, zazen, and the teacher-student relationship. Radical simplicity. Koans systematically break conceptual identity. Can produce profound shifts — or reinforce dissociation.",plain:"A meditation practice using sitting, riddles (koans), and working closely with a teacher. Cuts through thinking to direct experience.",url:"https://www.sfzc.org",urlLabel:"San Francisco Zen Center"},
  dzog:{desc:"The 'Great Perfection' — Tibetan practice of recognizing rigpa (pure awareness) as always already present. Self-liberation: thoughts and emotions release themselves upon recognition. Advanced practice requiring strong foundation.",plain:"An advanced meditation practice of recognizing that your fundamental awareness is already perfect and complete. Thoughts and emotions release themselves when truly seen.",url:"https://www.shambhala.com/dzogchen",urlLabel:"Shambhala — Dzogchen"},
  adv:{desc:"Hindu nondual tradition of direct self-inquiry. 'Who am I?' — tracing the I-thought to its source. Dissolves identification with body, mind, and personality. Powerful for identity reorganization.",plain:"The practice of asking 'Who am I?' and following that question deeper than thinking. Dissolves the sense of being a separate, fixed self.",url:"https://www.sriramanamaharshi.org",urlLabel:"Sri Ramana Maharshi Ashram"},
  real:{desc:"Judith Blackstone's embodied nondual approach. Inhabits the internal space of the body as the ground of being. Unique in bridging nondual realization with embodied presence — doesn't transcend the body to find awareness.",plain:"An approach that finds open awareness inside the body rather than by leaving it. Bridges spiritual realization with being fully embodied.",url:"https://realizationprocess.org",urlLabel:"Realization Process"},
  cenpr:{desc:"Christian contemplative practice of consenting to God's presence and action. Letting go of thoughts and resting in stillness. Similar mechanism to shamatha — surrender through devotion rather than technique.",plain:"A Christian meditation practice of sitting in open, consenting silence. Letting go of thoughts and resting in divine presence.",url:"https://www.contemplativeoutreach.org",urlLabel:"Contemplative Outreach"},
  sufi:{desc:"Islamic mystical tradition. Whirling as embodied meditation — the body becomes a channel for divine love. Fana (ego annihilation) as the goal. Works with subtle body through devotion and movement.",plain:"An Islamic mystical practice that uses spinning, chanting, and devotion to open the heart and dissolve the ego through divine love.",url:"https://sufism.org",urlLabel:"International Association of Sufism"},
  kirtan:{desc:"Devotional call-and-response chanting from Hindu tradition. Opens the heart through sound, repetition, and communal singing. Surfaces grief and longing. Works at the boundary of contemplative and relational.",plain:"Group call-and-response chanting that opens the heart. The repetitive singing together creates a powerful emotional and communal experience.",url:"https://www.krishnadas.com",urlLabel:"Krishna Das"},
  yoga:{desc:"Asana (postures), pranayama (breathwork), and meditation. Yoga Nidra is especially therapeutic — a guided state between waking and sleeping that accesses deep layers. Trauma-sensitive yoga adapts for PTSD.",plain:"Body postures, breathing exercises, and meditation. Yoga Nidra (guided deep rest) is especially healing. Trauma-sensitive yoga is adapted to be safe for people with trauma.",url:"https://www.yogaalliance.org",urlLabel:"Yoga Alliance"},
  kundy:{desc:"Yoga practice specifically targeting energetic awakening through the chakra system. Combines breathwork, movement, chanting, and meditation. Powerful but can destabilize — premature kundalini awakening is a real risk.",plain:"A yoga practice aimed at activating energy through the body's energy centers. Can be very powerful but also overwhelming if your system isn't ready.",url:"https://www.3ho.org",urlLabel:"3HO Foundation (Kundalini Yoga)"},
  hrid:{desc:"Heart-centered yoga from the Hridaya school. Combines meditation, self-inquiry, and Hatha yoga with emphasis on the spiritual heart center. Bridges devotion and nondual awareness through the body.",plain:"A heart-centered yoga practice that combines movement, meditation, and self-inquiry. Focuses on opening the spiritual heart.",url:"https://hridaya-yoga.com",urlLabel:"Hridaya Yoga"},
  taichi:{desc:"Moving meditation cultivating qi (life force) through slow, intentional movement. Builds interoceptive awareness, capacity, and energetic sensitivity. Internal martial arts tradition with therapeutic applications.",plain:"Slow, flowing movement practice that builds body awareness, calm, and energy. A moving meditation that strengthens your ability to feel what's happening inside.",url:"https://www.americantaichi.net",urlLabel:"American Tai Chi and Qigong Association"},
  martial:{desc:"Internal martial arts (Aikido, Tai Chi combat, Systema, Baguazhang). Training fight responses in a controlled context can complete self-defense impulses. Develops embodied agency and appropriate aggression.",plain:"Internal martial arts that develop your ability to use healthy aggression and stand your ground. Can help complete 'fight' responses that got stuck.",url:"https://www.aikidojournal.com",urlLabel:"Aikido Journal"},
  ci:{desc:"Improvisational partner dance following gravity, momentum, and points of contact. Develops relational attunement through the body — nonverbal, present-moment, and deeply intimate without being sexual.",plain:"An improvisational partner dance that develops trust, body awareness, and nonverbal connection. Deeply intimate without being sexual — communication through movement.",url:"https://contactquarterly.com",urlLabel:"Contact Quarterly"},
  rhythms:{desc:"5Rhythms and similar ecstatic dance forms. Free movement through a wave pattern: flowing, staccato, chaos, lyrical, stillness. Accesses emotion, energy, and shadow through uninstructed movement.",plain:"Free-form dance moving through different rhythms and energies. Lets your body express what it needs to without choreography or instruction.",url:"https://www.5rhythms.com",urlLabel:"5Rhythms"},
  feld:{desc:"Feldenkrais and Alexander Technique — movement education that increases awareness of habitual patterns and introduces new possibilities. Works at the interface of habit and choice.",plain:"Gentle movement practices that help you notice unconscious habits in how you move and find new, easier ways. Changes happen through awareness, not force.",url:"https://feldenkrais.com",urlLabel:"Feldenkrais Method"},
  rolf:{desc:"Structural Integration — deep fascial manipulation to reorganize the body in relation to gravity. Releases held patterns at the tissue level. Piezoelectric properties of fascia may explain energetic effects.",plain:"Deep bodywork that reorganizes the connective tissue (fascia) throughout your body. Releases patterns of tension held at the tissue level.",url:"https://www.rolf.org",urlLabel:"Rolf Institute"},
  cranio:{desc:"Extremely gentle hands-on work with the craniosacral system — subtle rhythms of cerebrospinal fluid. Works at the interface of somatic and energetic. Subtle but powerful for sensitive or fragile systems.",plain:"Very gentle hands-on work that follows subtle rhythms in your body. Good for sensitive systems — works at a level between physical tissue and energy.",url:"https://www.upledger.com",urlLabel:"Upledger Institute"},
  massage:{desc:"Touch-based bodywork ranging from Swedish relaxation to deep tissue, Thai massage, and myofascial release. Settles the nervous system through touch. Effects often temporary unless combined with awareness.",plain:"Hands-on bodywork from gentle relaxation to deep tissue. Calms the nervous system through touch — effects last longer when combined with body awareness.",url:"https://www.amtamassage.org",urlLabel:"American Massage Therapy Association"},
  acu:{desc:"Traditional Chinese Medicine meridian system — needles, herbs, moxa. Thousands of years of refined practice working with qi flow. Directly addresses energetic reorganization. Increasingly evidence-supported for pain and stress.",plain:"Ancient Chinese medicine using fine needles along energy pathways. Works with your body's energy flow to promote healing. Increasingly backed by modern research.",url:"https://www.nccaom.org",urlLabel:"National Certification Commission for Acupuncture"},
  plant:{desc:"Psychedelic-assisted therapy (psilocybin, ayahuasca, MDMA, etc.). The strongest catalyst available — opens all dimensions simultaneously. MDMA uniquely powerful for relational repair. Requires preparation, integration, and existing capacity.",plain:"Psychedelic-assisted experiences (mushrooms, MDMA, ayahuasca). The most powerful catalyst available but requires careful preparation, guidance, and integration afterward.",url:"https://maps.org",urlLabel:"MAPS (Multidisciplinary Association for Psychedelic Studies)"},
  holo:{desc:"Stanislav Grof's breathwork technique using hyperventilation and music to induce non-ordinary states. Powerful activator — similar intensity to plant medicine without the pharmacology. Can overwhelm unprepared systems.",plain:"A powerful breathing technique that uses fast breathing and music to access altered states. Similar intensity to psychedelics without substances — can be overwhelming.",url:"https://www.holotropic.com",urlLabel:"Grof Transpersonal Training"},
  wimhof:{desc:"Cold exposure and breathwork protocol. Builds stress tolerance and autonomic nervous system control. Strong physiological effects — energetic sensations are real but framed physiologically rather than energetically.",plain:"A practice combining cold exposure (ice baths) and intense breathing. Builds stress tolerance and nervous system control. Energizing but intense.",url:"https://www.wimhofmethod.com",urlLabel:"Wim Hof Method"},
  nature:{desc:"Deep nature connection, soulcraft (Bill Plotkin), wilderness therapy. Relationship with the more-than-human world as co-regulator, mirror, and initiator. Works across multiple dimensions when practiced with intention.",plain:"Spending time in nature as a healing practice — not just relaxation but deep relationship with the natural world. Can be a mirror for inner work.",url:"https://www.animas.org",urlLabel:"Animas Valley Institute"},
  vision:{desc:"Solo wilderness fast — typically 3-4 days alone without food. A death-and-rebirth initiatory structure. Powerful for identity reorganization when supported by community and preparation.",plain:"A solo wilderness experience, usually fasting alone for several days. A rite of passage — an encounter with yourself stripped of all distractions.",url:"https://schooloflostborders.org",urlLabel:"School of Lost Borders"},
  sweat:{desc:"Ceremonial practice from various indigenous traditions. Combines extreme heat, darkness, prayer, and community. An ordeal that strips defenses and opens the participant to transformation.",plain:"A ceremonial practice using extreme heat in a small enclosed structure. The ordeal strips away defenses and opens space for transformation.",url:"https://www.nativepartnership.org",urlLabel:"Partnership With Native Americans"},
  hoop:{desc:"Hawaiian forgiveness practice — taking 100% responsibility for one's experience. 'I'm sorry, please forgive me, thank you, I love you.' Updates relational models through radical responsibility.",plain:"A Hawaiian practice of taking full responsibility and offering forgiveness. Four phrases — I'm sorry, please forgive me, thank you, I love you — repeated as a healing practice.",url:"https://www.hooponopono.org",urlLabel:"Foundation of I (Ho'oponopono)"},
  float:{desc:"Sensory deprivation tanks — floating in body-temperature saltwater in darkness and silence. Reduces sensory input to let the nervous system reset to baseline. Builds subtle awareness.",plain:"Floating in a dark, quiet tank of warm saltwater. Removes all sensory input so your nervous system can deeply rest and reset.",url:"https://www.floatationlocations.com",urlLabel:"Float Tank Association"},
  vns:{desc:"Direct electrical or mechanical stimulation of the vagus nerve. Tones parasympathetic pathways. Emerging evidence for PTSD, depression, and anxiety. Works at the neurological level.",plain:"Devices that stimulate your vagus nerve (the main 'calming' nerve) through gentle electrical signals. Helps your nervous system shift out of stress mode.",url:"https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9044553/",urlLabel:"NIH — Vagus Nerve Stimulation Research"},
  ket:{desc:"Ketamine-assisted therapy — dissociative anesthetic creating a neuroplasticity window. Can break through treatment-resistant depression. Ego dissolution through chemical dissociation rather than meditative insight. Requires careful integration.",plain:"A medically supervised treatment using ketamine to create a brain state where old patterns can shift. Can help with severe depression when other approaches haven't worked.",url:"https://www.ketamineclinicsla.com/education",urlLabel:"Ketamine Clinics — Patient Education"},
};

/* ━━ Conditions / Pathologies ━━ */
const CONDITIONS = [
  { id:"cptsd", name:"Complex PTSD",
    desc:"Chronic relational trauma — developmental, not single-incident. Pervasive shame, relational distrust, emotional dysregulation, fragmented sense of self.",
    plainDesc:"Ongoing trauma from early relationships — not a single event but a pattern. Affects how safe you feel with people, how you handle emotions, and your sense of who you are.",
    dimWeights:{capacity:3,ground:3,completion:2,affect:2,models:2,diff:1,identity:1,shadow:1,energetic:1},
    essential:["se","ifs","eft"],
    recommended:["emdr","dbt","hakomi","sm"],
    helpful:["yoga","nfb","step12","cranio"],
    caution:["biocore","fam","forum","kundy"],
    contraindicated:["plant","holo","istdp","vision"],
    trapRisk:["Insufficient Ground","Catharsis Without Integration","Relational Avoidance"],
    minProgram:4, maxProgram:6,
    programNote:"Start with SE for capacity + IFS for parts work + one relational modality (EFT or group). Add EMDR once stabilized. Go slow — this is marathon work, not sprint work.",
    plainProgramNote:"Start with a body-based approach for stability, a parts-based approach for inner work, and one relationship-focused practice. Add trauma processing once you feel stable. This is a long road — go slow.",
  },
  { id:"ptsd", name:"PTSD (Single-Incident)",
    desc:"Discrete traumatic event(s) with intrusion, avoidance, hyperarousal. The body is stuck in the event. Often better baseline capacity than C-PTSD.",
    plainDesc:"Your body is stuck in a specific overwhelming event. Flashbacks, nightmares, being on high alert. The survival response never completed.",
    dimWeights:{completion:3,capacity:2,affect:2,diff:2,models:1,ground:1,identity:0,shadow:0,energetic:1},
    essential:["se","emdr"],
    recommended:["sm","tre","yoga"],
    helpful:["nfb","vns","nature"],
    caution:["biocore","fam"],
    contraindicated:["plant","holo","istdp"],
    trapRisk:["Insufficient Ground","Catharsis Without Integration"],
    minProgram:2, maxProgram:4,
    programNote:"SE and EMDR are the gold standard — either alone can resolve single-incident PTSD. Add body-based support (TRE, yoga) if needed. This is often the most resolvable condition on this list.",
    plainProgramNote:"Two approaches can often be enough here — a body-based trauma therapy and EMDR. Add gentle movement if you need more support. Single-event trauma is often the most resolvable kind.",
  },
  { id:"depression", name:"Depression",
    desc:"Collapse, withdrawal, anhedonia. Often frozen affect — grief, rage, or longing underneath numbness. The organism gave up on getting needs met.",
    plainDesc:"Feeling flat, withdrawn, or shut down. Often there are buried emotions — grief, anger, or longing — underneath the numbness. Part of you gave up on getting what you needed.",
    dimWeights:{affect:3,completion:2,capacity:2,ground:3,models:2,shadow:2,identity:1,energetic:1,diff:1},
    essential:["biocore","gestalt","men"],
    recommended:["rc","step12","rhythms","yoga","music"],
    helpful:["ifs","nature","art","kirtan","drama"],
    caution:["float","talk"],
    contraindicated:["vip","zen","maha"],
    trapRisk:["Relational Avoidance","Spiritual Bypass","Shadow Avoidance"],
    minProgram:3, maxProgram:5,
    programNote:"Depression is collapse — the priority is activation, not insight. Bioenergetics physically mobilizes frozen energy. Gestalt restores emotional aliveness. A relational container (men's/women's group or 12-step) breaks isolation. Add expressive modalities (music, rhythm) once moving.",
    plainProgramNote:"Depression is the body shutting down. The first step is getting energy moving — through the body, through connection with others, through emotional expression. Sitting meditation and isolation make it worse. Start with something physical + something relational + something expressive.",
  },
  { id:"anxiety", name:"Anxiety / Panic",
    desc:"Chronic activation without discharge. Nervous system locked in threat mode. Hypervigilance, catastrophizing, somatic symptoms. Often incomplete fight/flight.",
    plainDesc:"Your body is stuck in alarm mode — tense, scanning for danger, unable to settle. Panic attacks, chronic worry, physical symptoms. Your fight-or-flight response is running but never completing.",
    dimWeights:{capacity:3,completion:3,diff:2,affect:1,models:1,ground:1,energetic:1,shadow:0,identity:0},
    essential:["se","dbt","yoga"],
    recommended:["tre","nfb","taichi"],
    helpful:["vns","float","nature","act","feld"],
    caution:["biocore","wimhof"],
    contraindicated:["istdp","holo","kundy","plant"],
    trapRisk:["Insufficient Ground","Chemical Shortcut"],
    minProgram:3, maxProgram:5,
    programNote:"The nervous system needs to learn it can settle. SE teaches pendulation. DBT gives distress tolerance skills. Yoga/breathing builds regulation from within. Neurofeedback directly trains nervous system patterns. Avoid anything that deliberately increases activation.",
    plainProgramNote:"Your nervous system needs to learn it can calm down. Start with a body-based approach that teaches settling, practical skills for handling overwhelm, and a gentle movement practice. Avoid anything intense or activating until your baseline shifts.",
  },
  { id:"attachment", name:"Attachment Disorders",
    desc:"Insecure attachment patterns — anxious, avoidant, or disorganized. Core beliefs about relationships formed in earliest bonds. The relational field IS the wound.",
    plainDesc:"The way you learned to connect (or not connect) with people early in life is still running. You might cling, withdraw, or alternate between both. Relationships feel unsafe in a deep, automatic way.",
    dimWeights:{ground:3,models:3,affect:2,diff:2,capacity:2,shadow:2,identity:1,completion:1,energetic:0},
    essential:["eft","ifs","grpther"],
    recommended:["circ","men","step12","psychodyn"],
    helpful:["cuddle","gestalt","rc","hakomi"],
    caution:["float","nfb"],
    contraindicated:["maha","vip","zen"],
    trapRisk:["Relational Avoidance","Intellectualization","Shadow Avoidance"],
    minProgram:3, maxProgram:5,
    programNote:"The wound IS relational — individual work alone can't reach it. EFT restructures attachment in your primary relationship. IFS accesses the parts organized around attachment. At least one group modality (group therapy, circling, men's/women's group) is essential for new relational experience.",
    plainProgramNote:"This wound formed in relationships, so it has to heal in relationships. You need at least one practice focused on your closest relationship, one for inner work with the parts of you that feel unsafe, and one group setting where you practice new ways of connecting.",
  },
  { id:"addiction_active", name:"Active Addiction",
    desc:"Currently using substances or engaging in compulsive behavior. Capacity is minimal and the system is overwhelmed. Simplicity and community are paramount — the organism cannot benefit from complex therapeutic work while actively using.",
    plainDesc:"Still in the grip of the substance or behavior. Right now the priority is simple: get stable, get connected, get sober. Your system can't do deeper work while actively using — don't try to. Start with just a few things.",
    dimWeights:{capacity:3,ground:3,affect:1,shadow:0,models:1,completion:0,diff:0,identity:1,energetic:0},
    essential:["step12"],
    recommended:["dbt","yoga"],
    helpful:["nature"],
    caution:["ifs","se","gestalt","men","rc","talk","biocore"],
    contraindicated:["plant","ket","holo","istdp","exkink","kundy","vision","fam","forum","hrid","wimhof"],
    trapRisk:["Chemical Shortcut","Insufficient Ground"],
    minProgram:2, maxProgram:3,
    programNote:"12-Step is the cornerstone — the evidence is overwhelming and the community, sponsorship, and structure are irreplaceable during active addiction. Add DBT for distress tolerance when urges hit, and a gentle body practice (yoga, nature) for basic regulation. That's enough. Everything else is premature and risks overwhelm or relapse.",
    plainProgramNote:"Keep it simple. A 12-step program gives you community, structure, and someone to call when it gets hard. Add skills for handling cravings and one gentle body practice. That's your whole program right now. Everything else can come later — trying to do deep inner work while using doesn't work.",
  },
  { id:"addiction_recovery", name:"Early Recovery (Addiction)",
    desc:"Sober but fragile. The protective layer is down and unfelt material is surfacing. Capacity is building but still limited. The work now is learning to feel without self-medicating, within a strong relational container.",
    plainDesc:"You've stopped using but you're raw. The feelings the substance was managing are starting to surface. You need support, stability, and to slowly learn how to handle what comes up without reaching for the old solution.",
    dimWeights:{capacity:3,affect:3,ground:3,shadow:2,models:2,completion:1,diff:1,identity:2,energetic:0},
    essential:["step12","se","ifs"],
    recommended:["men","rc","yoga","dbt"],
    helpful:["gestalt","nature","music","nfb"],
    caution:["fam","forum","biocore"],
    contraindicated:["plant","ket","holo","istdp","exkink","kundy","vision"],
    trapRisk:["Chemical Shortcut","Insufficient Ground","Healing as Identity"],
    minProgram:4, maxProgram:6,
    programNote:"12-Step remains the backbone — sponsorship and community hold you while the deeper work begins. SE teaches your nervous system to regulate without substances. IFS meets the parts that drove the addiction with compassion. Add relational work (men's/women's group, RC) when stable enough. Existential kink and shadow work come much later — the system needs more ground first.",
    plainProgramNote:"Keep your 12-step community — that's your foundation. Now add body-based work to teach your nervous system to handle feelings without substances, and parts work to understand what was driving the addiction. Add a peer support group when you're ready. Shadow work and deep emotional work come later, once you're on solid ground.",
  },
  { id:"dissociation", name:"Dissociation / Structural Dissociation",
    desc:"Parts of experience are compartmentalized. Ranges from mild depersonalization to DID. The system fragmented to survive. Integration must proceed at the organism's pace.",
    plainDesc:"Parts of your experience are walled off from each other. You might feel detached from your body, have gaps in memory, or feel like different 'versions' of yourself. Your system split up to survive something overwhelming.",
    dimWeights:{capacity:3,ground:3,diff:3,affect:2,completion:1,models:1,shadow:2,identity:1,energetic:1},
    essential:["se","ifs","dbt"],
    recommended:["sm","hakomi","nfb"],
    helpful:["yoga","cranio","nature"],
    caution:["fam","men","biocore","rhythms"],
    contraindicated:["plant","holo","istdp","kundy","vision","exkink","forum","wimhof"],
    trapRisk:["Insufficient Ground","Catharsis Without Integration","Spiritual Bypass"],
    minProgram:3, maxProgram:4,
    programNote:"Go slow — this is the condition where premature depth is most dangerous. SE provides titrated body-based capacity building. IFS works with parts at their own pace. DBT gives grounding skills for when parts switch or overwhelm hits. Everything must proceed at the organism's pace. The caution and contraindicated lists are the longest here for good reason.",
    plainProgramNote:"Slow and gentle is the rule here. Your system split for a reason and it needs to reconnect at its own pace. Start with a body-based approach that goes very slowly, parts work that respects each part's readiness, and practical grounding skills. Avoid anything intense — this condition has the longest 'be careful' list for good reason.",
  },
  { id:"shame", name:"Toxic Shame / Low Self-Worth",
    desc:"Pervasive sense of deficiency. Not 'I did something bad' but 'I am bad.' Identity organized around unworthiness. Shadow material is often the disowned competence, power, or goodness.",
    plainDesc:"A deep, pervasive feeling that something is wrong with you — not that you made a mistake, but that you ARE the mistake. Often the parts of yourself you've hidden away are actually your strength, power, or goodness.",
    dimWeights:{shadow:3,identity:2,models:3,ground:2,affect:2,diff:1,capacity:1,completion:1,energetic:0},
    essential:["ifs","exkink","men"],
    recommended:["step12","gestalt","circ","jung"],
    helpful:["rc","psychodyn","art","drama"],
    caution:["cbt","talk"],
    contraindicated:["istdp","forum"],
    trapRisk:["Shadow Avoidance","Healing as Identity","Intellectualization"],
    minProgram:3, maxProgram:5,
    programNote:"The shadow IS the medicine here — what's been disowned is often competence, power, or goodness. IFS accesses shame-carrying exiles with Self-energy. Existential kink directly faces the hidden desire in the shame structure. A men's/women's group provides the experience of being seen and accepted. Avoid anything confrontational (ISTDP) or that reduces shame to faulty cognition (CBT).",
    plainProgramNote:"What you've hidden from yourself is often your strength. You need a practice that gently accesses the parts carrying the shame, a practice that helps you face what you've rejected about yourself, and a group where you're seen and accepted as you are. Avoid anything harshly confrontational or that treats shame as just 'wrong thinking.'",
  },
  { id:"grief", name:"Grief / Loss",
    desc:"Unmetabolized loss. May be recent or ancient, recognized or disenfranchised. The organism needs to complete the grieving process — not resolve or move past, but move through.",
    plainDesc:"Loss that hasn't been fully felt — whether recent or from long ago. The grieving process needs to complete, not be explained or bypassed. Your system needs to move through it, not around it.",
    dimWeights:{affect:3,ground:2,completion:2,capacity:1,identity:2,shadow:1,diff:1,models:1,energetic:1},
    essential:["gestalt","rc","music"],
    recommended:["men","ifs","nature","art"],
    helpful:["kirtan","psychodyn","drama","yoga"],
    caution:["talk"],
    contraindicated:["cbt","nlp","act"],
    trapRisk:["Intellectualization","Spiritual Bypass"],
    minProgram:2, maxProgram:4,
    programNote:"Grief needs to be felt, not fixed. Gestalt's empty chair work allows direct contact with the lost person or thing. RC provides structured discharge — the shaking, crying, and wailing that grief needs. Music and voice work reach below words. Group witnessing (men's/women's group) makes grief communal rather than isolating. Avoid anything that reframes, accepts, or cognitively restructures the loss.",
    plainProgramNote:"Grief needs to move through you — it can't be thought through or gotten over. Start with something that lets you feel it directly (like Gestalt or empty chair work), something that lets you discharge it physically (like co-counseling), and something that reaches below words (like music or voice work). Avoid anything that tries to reframe or 'fix' the loss.",
  },
  { id:"somatic", name:"Somatic / Chronic Pain Conditions",
    desc:"Psychosomatic symptoms, fibromyalgia, chronic fatigue, autoimmune flares correlated with stress. The body holds what the mind cannot. Often the body IS the primary communication channel.",
    plainDesc:"Your body is expressing what your mind hasn't been able to process — chronic pain, fatigue, tension, or illness that connects to emotional stress. The body is the main channel of communication here.",
    dimWeights:{completion:3,energetic:3,capacity:2,affect:2,shadow:1,diff:1,ground:1,models:0,identity:0},
    essential:["se","sm","cranio"],
    recommended:["yoga","acu","feld","hakomi"],
    helpful:["rolf","taichi","massage","nature"],
    caution:["talk","cbt"],
    contraindicated:["istdp"],
    trapRisk:["Intellectualization","Shadow Avoidance"],
    minProgram:3, maxProgram:5,
    programNote:"The body is the primary communication channel — work must go through the body, not around it. SE tracks how the body holds the material. Sensorimotor integrates body sensation with meaning. Craniosacral works at the subtlest somatic level. Add energy-based work (acupuncture, Feldenkrais) for reorganization. Avoid anything that bypasses the body to work cognitively.",
    plainProgramNote:"Your body is doing the talking here, so the work needs to go through the body. Start with body-based approaches that track what's happening physically, work at a gentle level, and help the body reorganize. Approaches that work through energy channels (like acupuncture) can also help. Avoid anything that tries to think or talk your body out of its symptoms.",
  },
];

const COND_MAP = {};
CONDITIONS.forEach(c => COND_MAP[c.id] = c);

function getCats(id) {
  const cats = [];
  Object.entries(MOD_CATS).forEach(([cat, ids]) => { if(ids.includes(id)) cats.push(cat); });
  return cats;
}

function recommend(sel, assessment, activeConds) {
  const {results, trapRisks} = assessment;
  const gapDims = results.filter(r => r.level === "none" || r.level === "weak");
  const modDims = results.filter(r => r.level === "moderate");
  if(gapDims.length === 0 && modDims.length === 0 && (!activeConds || activeConds.size === 0)) return { primary: [], secondary: [], condNotes: [] };

  // Merge condition data into tiered lookup
  const condDimBoost = {};
  const condTier = {}; // modId → best tier across all active conditions
  const condTraps = new Set();
  const condNotes = [];
  if(activeConds && activeConds.size > 0) {
    activeConds.forEach(cId => {
      const cond = COND_MAP[cId];
      if(!cond) return;
      Object.entries(cond.dimWeights).forEach(([dId, w]) => {
        condDimBoost[dId] = (condDimBoost[dId]||0) + w;
      });
      // Build tier map — keep the best (lowest number = highest priority) tier for each modality
      (cond.essential||[]).forEach(id => { if(!condTier[id] || condTier[id] > 1) condTier[id] = 1; });
      (cond.recommended||[]).forEach(id => { if(!condTier[id] || condTier[id] > 2) condTier[id] = 2; });
      (cond.helpful||[]).forEach(id => { if(!condTier[id] || condTier[id] > 3) condTier[id] = 3; });
      (cond.caution||[]).forEach(id => { if(!condTier[id] || condTier[id] > 4) condTier[id] = 4; });
      (cond.contraindicated||[]).forEach(id => { condTier[id] = 5; }); // contraindicated always wins
      (cond.trapRisk||[]).forEach(t => condTraps.add(t));
      if(cond.programNote) condNotes.push({name:cond.name, note:cond.programNote, plainNote:cond.plainProgramNote, min:cond.minProgram, max:cond.maxProgram});
    });
  }

  const hasConds = activeConds && activeConds.size > 0;

  // What categories does the user already cover?
  const userCats = new Set();
  sel.forEach(id => getCats(id).forEach(c => userCats.add(c)));

  // Score each unselected modality
  const candidates = MOD_KEYS.filter(k => !sel.has(k)).map(id => {
    let score = 0;
    let gapsFilled = [];
    let modsBoosted = [];
    let reasons = [];
    const tier = condTier[id] || 0; // 0 = no condition opinion

    // Contraindicated modalities get heavily penalized and flagged
    if(tier === 5) {
      score -= 80;
      reasons.push("⛔ Contraindicated for selected conditions");
    }

    // Caution modalities get penalized
    if(tier === 4) {
      score -= 20;
      reasons.push("⚠ Use caution with selected conditions");
    }

    // 1. How many gap dimensions does this modality cover as effective?
    gapDims.forEach(r => {
      const isEff = (r.dim.eff||[]).some(m => m.id === id);
      const isPar = (r.dim.par||[]).some(m => m.id === id);
      const dimBoost = condDimBoost[r.dim.id] ? (1 + condDimBoost[r.dim.id] * 0.25) : 1;
      if(isEff) { score += 30 * dimBoost; gapsFilled.push(r.dim.name); }
      else if(isPar) { score += 10 * dimBoost; gapsFilled.push(r.dim.name + " (partial)"); }
    });

    // 2. Does it boost moderate dimensions to strong?
    modDims.forEach(r => {
      const isEff = (r.dim.eff||[]).some(m => m.id === id);
      const dimBoost = condDimBoost[r.dim.id] ? (1 + condDimBoost[r.dim.id] * 0.2) : 1;
      if(isEff) { score += 12 * dimBoost; modsBoosted.push(r.dim.name); }
    });

    // 2b. Condition dimension weighting
    if(hasConds) {
      DIMS.forEach(dim => {
        const w = condDimBoost[dim.id] || 0;
        if(w >= 2) {
          const isEff = (dim.eff||[]).some(m => m.id === id);
          const r = results.find(x => x.dim.id === dim.id);
          if(isEff && r && r.level !== "strong") {
            score += w * 3;
          }
        }
      });
    }

    // 3. Complementarity bonus
    const modCats = getCats(id);
    const newCats = modCats.filter(c => !userCats.has(c));
    if(newCats.length > 0) {
      score += 15;
      reasons.push("Adds " + newCats.join(", ") + " approach");
    }

    // 4. Trap mitigation
    const highTraps = trapRisks.filter(t => t.risk === "high" || condTraps.has(t.name));
    highTraps.forEach(t => {
      const trapDimIds = t.dims;
      trapDimIds.forEach(dId => {
        const dim = DIMS.find(d => d.id === dId);
        if(dim && (dim.eff||[]).some(m => m.id === id)) {
          score += condTraps.has(t.name) ? 12 : 8;
          reasons.push("Mitigates " + t.name + " trap");
        }
      });
    });

    // 5. Tiered condition bonuses (only for positive tiers)
    if(tier === 1) {
      score += 45;
      reasons.push("Essential for selected conditions");
    } else if(tier === 2) {
      score += 25;
      reasons.push("Recommended for selected conditions");
    } else if(tier === 3) {
      score += 12;
      reasons.push("Helpful for selected conditions");
    }

    // 6. Mild penalty for modalities sharing blind spots with user's set
    const userIneffDims = results.filter(r => r.level === "none");
    const isAlsoIneff = userIneffDims.filter(r => (r.dim.ineff||[]).some(m => m.id === id));
    if(isAlsoIneff.length > 0) score -= 5 * isAlsoIneff.length;

    // Build reason string
    if(gapsFilled.length > 0) reasons.unshift("Fills gaps in " + gapsFilled.join(", "));
    else if(modsBoosted.length > 0) reasons.unshift("Strengthens " + modsBoosted.join(", "));

    const tierLabel = tier === 1 ? "essential" : tier === 2 ? "recommended" : tier === 3 ? "helpful" : tier === 4 ? "caution" : tier === 5 ? "contraindicated" : null;

    return { id, name: MODS[id], score, gapsFilled, modsBoosted, reasons, newCats, tier, tierLabel,
      isCaution: tier >= 4, isPreferred: tier >= 1 && tier <= 3, isEssential: tier === 1, isContraindicated: tier === 5 };
  });

  // Sort by score, take top recommendations
  candidates.sort((a,b) => b.score - a.score);

  // Filter out zero/negative scores (but always show contraindicated as warnings)
  const viable = candidates.filter(c => c.score > 0);
  const warnings = candidates.filter(c => c.tier === 5 || c.tier === 4);

  // Group into tiers
  const primary = viable.filter(c => c.score >= 40).slice(0, 5);
  const secondary = viable.filter(c => c.score >= 20 && c.score < 40).slice(0, 4);

  return { primary, secondary, condNotes, warnings };
}

/* ━━ Components ━━ */
function ModList({items, type}) {
  const dot = {effective:C.eff,partial:C.par,ineffective:C.ineff}[type];
  return <div>{items.map((m,i) => (
    <div key={i} style={{padding:"0.45rem 0",borderTop:i>0?`1px solid ${C.bdr}`:"none",display:"flex",gap:"0.5rem",alignItems:"flex-start"}}>
      <div style={{width:6,height:6,borderRadius:"50%",background:dot,flexShrink:0,marginTop:7}}/>
      <div><span style={{fontSize:"0.84rem",color:C.txL}}>{m.name}</span><span style={{fontSize:"0.79rem",color:C.txM}}> — {m.role||m.reason}</span></div>
    </div>
  ))}</div>;
}

function Detail({dim, mf, setMf, sel, st, setSt, descOverride, plain:isPlain}) {
  const filt = (arr) => {
    if(!arr) return [];
    if(!st) return arr;
    const t = st.toLowerCase();
    return arr.filter(m => m.name.toLowerCase().includes(t)||(m.role||m.reason||"").toLowerCase().includes(t));
  };
  const e=filt(dim.eff), p=filt(dim.par), n=filt(dim.ineff);
  const loops = LOOPS.filter(l=>l.from===sel||l.to===sel);

  return (
    <div style={{marginTop:"0.5rem",marginBottom:"0.75rem",background:C.card,border:`1px solid ${dim.colorL}33`,borderRadius:12,padding:"1.5rem",animation:"fadeIn 0.3s ease"}}>
      <p style={{fontSize:"0.85rem",color:C.txM,lineHeight:1.7,marginTop:0,marginBottom:"1rem"}}>{descOverride||dim.desc}</p>
      <input type="text" placeholder={isPlain?"Search practices...":"Search modalities..."} value={st} onChange={ev=>setSt(ev.target.value)} onClick={ev=>ev.stopPropagation()}
        style={{width:"100%",padding:"0.4rem 0.75rem",background:C.bg,border:`1px solid ${C.bdr}`,borderRadius:6,color:C.txL,fontFamily:"inherit",fontSize:"0.8rem",outline:"none",boxSizing:"border-box",marginBottom:"0.75rem"}}/>
      <div style={{display:"flex",gap:"0.25rem",marginBottom:"1rem",flexWrap:"wrap"}}>
        {[{k:"all",l:"All",c:C.bdr},{k:"effective",l:"Effective",c:C.eff},{k:"partial",l:"Partial",c:C.par},{k:"ineffective",l:"Ineffective",c:C.ineff}].map(x=>(
          <button key={x.k} onClick={ev=>{ev.stopPropagation();setMf(mf===x.k?"all":x.k)}}
            style={{padding:"0.35rem 0.75rem",background:mf===x.k?`${x.c}22`:"transparent",color:mf===x.k?C.txL:C.txM,border:`1px solid ${mf===x.k?x.c+"66":"transparent"}`,borderRadius:5,cursor:"pointer",fontFamily:"inherit",fontSize:"0.73rem"}}>
            {x.l}{x.k!=="all"?` (${x.k==="effective"?e.length:x.k==="partial"?p.length:n.length})`:""}
          </button>
        ))}
      </div>
      {(mf==="all"||mf==="effective")&&e.length>0&&<div style={{marginBottom:"1rem"}}><div style={{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"0.1em",color:"#7aba8a",marginBottom:"0.4rem"}}>● Effective</div><ModList items={e} type="effective"/></div>}
      {(mf==="all"||mf==="partial")&&p.length>0&&<div style={{marginBottom:"1rem"}}><div style={{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"0.1em",color:"#c0b070",marginBottom:"0.4rem"}}>◑ Partially Effective</div><ModList items={p} type="partial"/></div>}
      {(mf==="all"||mf==="ineffective")&&n.length>0&&<div style={{marginBottom:"1rem"}}><div style={{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.ineffTx,marginBottom:"0.4rem"}}>◯ Ineffective</div><ModList items={n} type="ineffective"/></div>}
      {!st&&loops.length>0&&<div style={{borderTop:`1px solid ${C.bdr}`,paddingTop:"0.75rem"}}>
        <div style={{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"0.1em",color:dim.colorL,marginBottom:"0.5rem"}}>{isPlain?"Connections Between Areas":"Feedback Loops"}</div>
        {loops.map((l,i)=>{const f=DIMS.find(d=>d.id===l.from),t=DIMS.find(d=>d.id===l.to);return(
          <div key={i} style={{padding:"0.4rem 0",borderTop:i>0?`1px solid ${C.bdr}`:"none",fontSize:"0.8rem",color:C.txM}}>
            <span style={{color:f.colorL}}>{f.name}</span> → <span style={{color:t.colorL}}>{t.name}</span>
            <div style={{marginTop:2,fontStyle:"italic",fontSize:"0.78rem"}}>{isPlain&&l.plain?l.plain:l.label}</div>
          </div>);
        })}
      </div>}
    </div>
  );
}

function DimCard({dimId, idx, dashed, selected, onSel, aResult, shortOverride, plain:isPlain}) {
  const dim = DIMS.find(d=>d.id===dimId);
  const isSel = selected===dimId;
  const isGround = idx === undefined && !dashed;
  return (
    <div onClick={()=>onSel(dimId)} style={{background:isSel?C.cardH:C.card,border:`1px solid ${isSel?dim.colorL:C.bdr}`,borderRadius:10,padding:"1rem 1.25rem",cursor:"pointer",transition:"all 0.25s",...(dashed?{borderStyle:"dashed"}:{})}}>
      <div style={{display:"flex",alignItems:"center",gap:"0.75rem"}}>
        {isGround ? <div style={{width:10,height:10,borderRadius:"50%",background:dim.color,flexShrink:0}}/> :
          <div style={{width:28,height:28,borderRadius:"50%",background:`${dim.color}22`,border:`2px ${dashed?"dashed":"solid"} ${dim.color}`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:dashed?"0.85rem":"0.75rem",color:dim.colorL,fontWeight:600,flexShrink:0}}>
            {dashed?"∿":idx+1}
          </div>}
        <div style={{flex:1}}>
          {isGround&&<div style={{fontSize:"0.7rem",color:dim.colorL,textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:2}}>Ground — Relational Field</div>}
          <div style={{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"}}>
            <span style={{fontSize:"1.05rem",color:C.txL}}>{isGround?"The medium in which all healing occurs":(isPlain&&dim.plainName?dim.plainName:dim.name)}</span>
            {!isGround&&!dashed&&<span style={{fontSize:"0.65rem",color:ZONE_C[dim.zone],background:`${ZONE_C[dim.zone]}18`,padding:"2px 8px",borderRadius:10,textTransform:"uppercase",letterSpacing:"0.08em"}}>{dim.zone}</span>}
            {dashed&&<span style={{fontSize:"0.65rem",color:dim.colorL,background:`${dim.color}18`,padding:"2px 8px",borderRadius:10,textTransform:"uppercase",letterSpacing:"0.08em"}}>{isPlain?"Cross-cutting":"Orthogonal"}</span>}
          </div>
          {!isGround&&<div style={{fontSize:"0.85rem",color:C.txM,marginTop:3}}>{shortOverride||dim.short}</div>}
        </div>
        {aResult&&<div style={{display:"flex",alignItems:"center",gap:"0.5rem",flexShrink:0}}>
          <div style={{width:40,height:6,borderRadius:3,background:C.bdr,overflow:"hidden"}}><div style={{width:`${aResult.score}%`,height:"100%",borderRadius:3,background:LVL_C[aResult.level],transition:"width 0.5s"}}/></div>
          <span style={{fontSize:"0.7rem",color:LVL_C[aResult.level],minWidth:52,textAlign:"right"}}>{LVL_L[aResult.level]}</span>
        </div>}
        <div style={{color:C.txM,fontSize:"1.2rem",flexShrink:0}}>{isSel?"−":"+"}</div>
      </div>
    </div>
  );
}

/* ━━ Main ━━ */
function App() {
  const [sel, setSel] = useState(null);
  const [view, setView] = useState("theory");
  const [mf, setMf] = useState("all");
  const [st, setSt] = useState("");
  const [mods, setMods] = useState(new Set());
  const [ms, setMs] = useState("");
  const [conds, setConds] = useState(new Set());
  const [condOpen, setCondOpen] = useState(false);
  const [openMod, setOpenMod] = useState(null);
  const [exportEmail, setExportEmail] = useState("");
  const [exportSent, setExportSent] = useState(false);
  const [plain, setPlain] = useState(false);

  const T = (key, fallback) => plain && PLAIN[key] ? PLAIN[key] : fallback;
  const dimShort = dim => T(dim.id+".short", dim.short);
  const dimDesc = dim => T(dim.id+".desc", dim.desc);
  const dimName = dim => plain && dim.plainName ? dim.plainName : dim.name;

  const toggleCond = id => { const n = new Set(conds); n.has(id)?n.delete(id):n.add(id); setConds(n); };

  const toggle = id => { const n = new Set(mods); n.has(id)?n.delete(id):n.add(id); setMods(n); };
  const pick = id => { setSel(sel===id?null:id); setMf("all"); setSt(""); };
  const selDim = DIMS.find(d=>d.id===sel);
  const asmnt = useMemo(()=>mods.size>0?assess(mods,conds):null,[mods,conds]);
  const recs = useMemo(()=>asmnt?recommend(mods,asmnt,conds):null,[mods,asmnt,conds]);
  const aRes = id => asmnt?.results.find(r=>r.dim.id===id);
  const filtMods = MOD_KEYS.filter(k => MODS[k].toLowerCase().includes(ms.toLowerCase()));

  // PDF export using jsPDF (loaded dynamically)
  const generatePDF = async () => {
    // Dynamically load jsPDF
    if(!window.jspdf) {
      const s = document.createElement("script");
      s.src = "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js";
      document.head.appendChild(s);
      await new Promise(r => s.onload = r);
    }
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
    const W = 210, M = 18, TW = W - M*2;
    let y = M;
    const addPage = () => { doc.addPage(); y = M; };
    const checkPage = (need) => { if(y + need > 280) addPage(); };

    // Colors
    const dark = "#0e0e14", med = "#8888aa", acc = "#7aba8a", warn = "#d47766";

    // Title
    doc.setFont("helvetica","bold"); doc.setFontSize(20); doc.setTextColor(30,30,40);
    doc.text("The Healing Spiral — Assessment Report", M, y); y += 10;
    doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(100,100,120);
    doc.text(new Date().toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}), M, y); y += 3;
    if(exportEmail) { doc.text("Prepared for: " + exportEmail, M + 60, y); }
    y += 8;
    doc.setDrawColor(180,180,200); doc.line(M, y, W-M, y); y += 8;

    // Selected modalities
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(30,30,40);
    doc.text(plain ? "Your Practices" : "Selected Modalities", M, y); y += 6;
    doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(80,80,100);
    const modList = [...mods].map(id => MODS[id]).sort();
    const modText = modList.join(", ") || "None selected";
    const modLines = doc.splitTextToSize(modText, TW);
    doc.text(modLines, M, y); y += modLines.length * 4 + 4;

    // Conditions
    if(conds.size > 0) {
      doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(30,30,40);
      doc.text("Conditions", M, y); y += 6;
      doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(80,80,100);
      [...conds].forEach(cId => {
        const c = COND_MAP[cId]; if(!c) return;
        checkPage(12);
        doc.setFont("helvetica","bold"); doc.setFontSize(9);
        doc.text("• " + c.name, M, y); y += 4;
        doc.setFont("helvetica","normal");
        const cLines = doc.splitTextToSize(plain && c.plainProgramNote ? c.plainProgramNote : (c.programNote||""), TW - 4);
        doc.text(cLines, M + 4, y); y += cLines.length * 3.5 + 3;
      });
      y += 4;
    }

    // Dimension Coverage
    if(asmnt) {
      checkPage(20);
      doc.setDrawColor(180,180,200); doc.line(M, y, W-M, y); y += 8;
      doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(30,30,40);
      doc.text(plain ? "Coverage Across Areas" : "Dimension Coverage", M, y); y += 8;

      asmnt.results.forEach(r => {
        checkPage(18);
        // Dim name and level
        doc.setFont("helvetica","bold"); doc.setFontSize(9); doc.setTextColor(30,30,40);
        doc.text(dimName(r.dim), M, y);
        const lvlColors = {strong:[90,160,100],moderate:[180,170,90],weak:[190,140,90],none:[160,100,90]};
        const lc = lvlColors[r.level] || [100,100,100];
        doc.setTextColor(lc[0],lc[1],lc[2]);
        doc.text(r.level.charAt(0).toUpperCase()+r.level.slice(1), M + TW - 20, y, {align:"right"});
        y += 3.5;

        // Bar
        doc.setFillColor(40,40,55); doc.roundedRect(M, y, TW, 3, 1.5, 1.5, "F");
        if(r.score > 0) {
          doc.setFillColor(lc[0],lc[1],lc[2]);
          doc.roundedRect(M, y, Math.max(3, TW * r.score / 100), 3, 1.5, 1.5, "F");
        }
        y += 5;

        // Matches
        doc.setFont("helvetica","normal"); doc.setFontSize(7.5); doc.setTextColor(100,100,120);
        const matchParts = [];
        if(r.eMatch.length > 0) matchParts.push("● " + r.eMatch.join(", "));
        if(r.pMatch.length > 0) matchParts.push("◑ " + r.pMatch.join(", "));
        if(r.harmMatch && r.harmMatch.length > 0) matchParts.push("⛔ " + r.harmMatch.join(", "));
        if(matchParts.length > 0) {
          const mLines = doc.splitTextToSize(matchParts.join("  ·  "), TW);
          doc.text(mLines, M, y); y += mLines.length * 3 + 1;
        }
        y += 3;
      });

      // Trap risks
      const activeTraps = asmnt.trapRisks.filter(t => t.risk !== "low");
      if(activeTraps.length > 0) {
        checkPage(15);
        y += 4;
        doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(30,30,40);
        doc.text(plain ? "Pitfall Risks" : "Trap Vulnerability", M, y); y += 7;
        activeTraps.forEach(t => {
          checkPage(12);
          doc.setFont("helvetica","bold"); doc.setFontSize(9);
          doc.setTextColor(t.risk==="high"?190:160, t.risk==="high"?90:150, t.risk==="high"?80:90);
          doc.text((t.risk==="high"?"⚠ ":"◑ ") + t.name + " (" + t.risk + ")", M, y); y += 4;
          doc.setFont("helvetica","normal"); doc.setFontSize(8); doc.setTextColor(100,100,120);
          const tLines = doc.splitTextToSize(t.desc, TW - 4);
          doc.text(tLines, M + 4, y); y += tLines.length * 3.5 + 3;
        });
      }

      // Recommendations
      if(recs && (recs.primary.length > 0 || recs.secondary.length > 0)) {
        checkPage(15);
        y += 4;
        doc.setDrawColor(180,180,200); doc.line(M, y, W-M, y); y += 8;
        doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(30,30,40);
        doc.text(plain ? "What to Consider Adding" : "Recommended Additions", M, y); y += 7;

        const allRecs = [...recs.primary.map(r=>({...r,tier_label:"HIGH IMPACT"})),...recs.secondary.map(r=>({...r,tier_label:"ALSO CONSIDER"}))];
        let lastTier = "";
        allRecs.forEach(r => {
          checkPage(12);
          if(r.tier_label !== lastTier) {
            doc.setFont("helvetica","bold"); doc.setFontSize(7.5); doc.setTextColor(100,140,110);
            doc.text(r.tier_label, M, y); y += 4; lastTier = r.tier_label;
          }
          doc.setFont("helvetica","bold"); doc.setFontSize(9); doc.setTextColor(30,30,40);
          let label = r.name;
          if(r.isEssential) label += " [essential]";
          else if(r.tier===2) label += " [recommended]";
          doc.text("+ " + label, M, y); y += 3.5;
          doc.setFont("helvetica","normal"); doc.setFontSize(8); doc.setTextColor(100,100,120);
          const rLines = doc.splitTextToSize(r.reasons.slice(0,2).join(". "), TW - 6);
          doc.text(rLines, M + 4, y); y += rLines.length * 3.5 + 3;
        });
      }
    }

    // Footer
    checkPage(20);
    y += 6;
    doc.setDrawColor(180,180,200); doc.line(M, y, W-M, y); y += 6;
    doc.setFont("helvetica","italic"); doc.setFontSize(8); doc.setTextColor(120,120,140);
    doc.text("Generated by The Healing Spiral — thehealingspiral.com", M, y); y += 3.5;
    doc.text("This assessment is informational, not diagnostic. It does not replace professional clinical guidance.", M, y);

    doc.save("healing-spiral-assessment.pdf");
  };

  const Arrow = () => <div style={{display:"flex",justifyContent:"center",padding:"0.15rem 0"}}><div style={{display:"flex",flexDirection:"column",alignItems:"center"}}><div style={{width:1,height:14,background:C.bdr}}/><div style={{color:C.txM,fontSize:"0.65rem",lineHeight:1}}>▾</div></div></div>;
  const Line = () => <div style={{display:"flex",justifyContent:"center",padding:"0.25rem 0"}}><div style={{width:1,height:20,background:C.bdr}}/></div>;

  const renderDim = (id, idx, dashed) => {
    const d = DIMS.find(x=>x.id===id);
    return (
    <div key={id}>
      <DimCard dimId={id} idx={idx} dashed={dashed} selected={sel} onSel={pick} aResult={view==="assess"?aRes(id):null} shortOverride={d?dimShort(d):undefined} plain={plain}/>
      {sel===id&&selDim&&<Detail dim={selDim} mf={mf} setMf={setMf} sel={sel} st={st} setSt={setSt} descOverride={dimDesc(selDim)} plain={plain}/>}
    </div>);
  };

  return (
    <div style={{minHeight:"100vh",background:C.bg,color:C.tx,fontFamily:"'Newsreader','Georgia',serif",padding:"2rem 1.5rem",maxWidth:960,margin:"0 auto"}}>
      <div style={{marginBottom:"2.5rem"}}>
        <h1 style={{fontSize:"1.75rem",fontWeight:400,color:C.txL,letterSpacing:"0.02em",marginBottom:"0.5rem"}}>The Healing Spiral</h1>
        <p style={{fontSize:"0.95rem",color:C.txM,lineHeight:1.6,maxWidth:640}}>{plain?"Nine areas of healing. 50+ approaches. One spiral process.":"Nine dimensions. 50+ modalities. One spiral process."}</p>
      </div>

      <div style={{display:"flex",gap:"0.25rem",marginBottom:"2rem",flexWrap:"wrap",alignItems:"center"}}>
        {[{k:"theory",l:plain?"Overview":"Theory"},{k:"cascade",l:"Cascade"},{k:"assess",l:plain?"Assess My Practices":"Assess My Program"},{k:"modalities",l:plain?"Approaches":"Modalities"},{k:"traps",l:plain?"Common Pitfalls":"Common Traps"},{k:"compass",l:plain?"Check-In":"Diagnostic"}].map(v=>(
          <button key={v.k} onClick={()=>{setView(v.k);setSel(null);setMf("all");setSt("");}}
            style={{padding:"0.5rem 1.25rem",background:view===v.k?C.cardH:"transparent",color:view===v.k?C.txL:C.txM,border:`1px solid ${view===v.k?C.bdr:"transparent"}`,borderRadius:6,cursor:"pointer",fontFamily:"inherit",fontSize:"0.85rem"}}>
            {v.l}
          </button>
        ))}
        <div style={{marginLeft:"auto",display:"flex",alignItems:"center",gap:"0.5rem"}}>
          <span style={{fontSize:"0.75rem",color:plain?C.txM:C.accL}}>Clinical</span>
          <div onClick={()=>setPlain(!plain)} style={{width:36,height:20,borderRadius:10,background:plain?C.acc:C.bdr,cursor:"pointer",position:"relative",transition:"background 0.25s",flexShrink:0}}>
            <div style={{width:16,height:16,borderRadius:8,background:C.txL,position:"absolute",top:2,left:plain?18:2,transition:"left 0.25s",boxShadow:"0 1px 3px #0004"}}/>
          </div>
          <span style={{fontSize:"0.75rem",color:plain?C.accL:C.txM}}>Simple</span>
        </div>
      </div>

      {/* ━━ THEORY ━━ */}
      {view==="theory"&&<div>
        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1rem"}}>
          <h2 style={{fontSize:"1.15rem",fontWeight:400,color:C.txL,marginTop:0,marginBottom:"0.75rem"}}>What Is Trauma?</h2>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0}}>
            {T("theory.trauma.1","Trauma is unintegrated experience. The organism did something intelligent to survive — froze, collapsed, dissociated, accommodated — and that adaptation now runs in contexts where it no longer serves. It lives in the body as incomplete survival responses, in the psyche as rigid predictions about relationships, and in identity as fixed self-structures built around the wound.")}
          </p>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0,marginTop:"0.75rem"}}>
            {T("theory.trauma.2","Healing means contacting, metabolizing, and integrating what couldn't be processed at the time. Not fixing what's broken — completing what was interrupted.")}
          </p>
        </div>

        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1rem"}}>
          <h2 style={{fontSize:"1.15rem",fontWeight:400,color:C.txL,marginTop:0,marginBottom:"0.75rem"}}>Nine {plain?"Areas":"Dimensions"} of {plain?"Healing":"Contact"}</h2>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0,marginBottom:"1rem"}}>
            {T("theory.dims","Rather than a linear sequence, healing involves nine dimensions of contact — seven in a cascade with dependency structure, plus two orthogonal dimensions that run throughout. Each has its own logic, its own modalities, and its own ways of getting stuck.")}
          </p>
          {[
            {color:C.gnd,name:"Relational Field",zone:"Ground",id:"ground"},
            {color:C.acc,name:"Capacity Building",zone:"Foundation",id:"capacity"},
            {color:C.som,name:"Physiological Completion",zone:"Body",id:"completion"},
            {color:C.som,name:"Affect Metabolization",zone:"Body → Psyche",id:"affect"},
            {color:C.psy,name:"Differentiation",zone:"Psyche",id:"diff"},
            {color:C.psy,name:"Implicit Model Updating",zone:"Psyche",id:"models"},
            {color:C.idn,name:"Identity Reorganization",zone:"Identity",id:"identity"},
            {color:C.eng,name:"Energetic Reorganization",zone:plain?"Subtle Body (Cross-cutting)":"Subtle Body (Orthogonal)",id:"energetic"},
            {color:C.shd,name:"Shadow Integration / Integrity",zone:plain?"Wholeness (Cross-cutting)":"Wholeness (Orthogonal)",id:"shadow"},
          ].map((d,i) => {
            const clinicalTexts = {
              ground:"The medium in which all healing occurs. Quality of presence, attunement, co-regulation, and witnessing determines whether anything else shifts or is merely performed. Developmental trauma happened in relationship; it resolves in relationship.",
              capacity:"The nervous system needs enough resources to enter difficult territory without overwhelm. Both internal regulation (pendulation between activation and settling) and external safety (relational holding). This isn't a stage you complete — it scales with depth throughout the spiral.",
              completion:"The body holds incomplete fight, flight, freeze, fawn, and collapse responses. Completion means finishing what was started: hands push, legs run, chest opens. Different from catharsis — genuine completion produces spontaneous settling and a new physiological baseline.",
              affect:"As the body completes, frozen emotional material surfaces — grief under anger, terror under numbness, longing under self-sufficiency. Metabolization is sustained conscious contact with feeling: not acting it out, not analyzing it, not transcending it. A slow digestive process that comes in waves.",
              diff:"Past from present. Part from whole self. Feeling from story. Awareness from content. As affect metabolizes, you see: 'this is the child's grief, not my adult reality.' Without somatic and affect work first, differentiation becomes mere intellectual mapping.",
              models:"The nervous system runs predictions formed under duress: 'people leave,' 'my needs are too much.' These update only when the old prediction is active AND met with disconfirming experience AND you're differentiated enough to notice the mismatch. This is why insight alone doesn't heal — corrective relational experience is the mechanism.",
              identity:"As enough implicit models update, the identity they supported loses coherence. 'The wounded one,' 'the strong one,' 'the helper' — dissolving. Can't be forced; happens when underlying material has shifted enough. Premature attempts produce spiritual bypass.",
              energetic:"More granular than muscular tension, more embodied than parts or meaning. Traditional systems map as meridians, chakras, nadis. This dimension operates somewhat independently — sometimes preceding, sometimes following, sometimes catalyzing the cascade. Requires soft, receptive attention.",
              shadow:"Other dimensions work with what's stuck. This dimension works with what's split off — actively excluded from self-experience. The mechanism isn't completion or metabolization but re-owning what was banished. Integrity as structural wholeness: nothing left out. At every level of the cascade, there's material that was forbidden rather than merely unfelt. Full integration requires going to exactly the places the system has organized itself to avoid.",
            };
            return (
            <div key={i} style={{marginBottom:"0.75rem",paddingLeft:"1rem",borderLeft:`2px solid ${d.color}`}}>
              <div style={{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.2rem"}}>
                <span style={{fontSize:"0.9rem",color:C.txL}}>{plain?(DIMS.find(x=>x.id===d.id)||{}).plainName||d.name:d.name}</span>
                <span style={{fontSize:"0.6rem",color:d.color,background:`${d.color}18`,padding:"1px 6px",borderRadius:8,textTransform:"uppercase",letterSpacing:"0.08em"}}>{d.zone}</span>
              </div>
              <p style={{fontSize:"0.82rem",color:C.txM,lineHeight:1.65,margin:0}}>{T("theory."+d.id, clinicalTexts[d.id])}</p>
            </div>);
          })}
        </div>

        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1rem"}}>
          <h2 style={{fontSize:"1.15rem",fontWeight:400,color:C.txL,marginTop:0,marginBottom:"0.75rem"}}>The Spiral, Not the Staircase</h2>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0}}>
            {T("theory.spiral.1","There is a natural dependency structure — capacity must be sufficient for whatever is trying to emerge, body completion precedes full affect metabolization, differentiation enables model updating — but the process is spiral, not linear. Each turn revisits all dimensions at greater depth as new material becomes accessible from the new baseline.")}
          </p>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0,marginTop:"0.75rem"}}>
            {T("theory.spiral.2","The dimensions aren't separate layers — they interpenetrate. A body state IS a part IS a meaning structure IS a relational pattern. Direction of entry matters less than quality of contact.")}
          </p>
        </div>

        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1rem"}}>
          <h2 style={{fontSize:"1.15rem",fontWeight:400,color:C.txL,marginTop:0,marginBottom:"0.75rem"}}>Why No Single {plain?"Approach":"Modality"} Is Enough</h2>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0}}>
            {T("theory.modality.1","Every healing modality privileges certain dimensions and is blind to others. Somatic Experiencing excels at body completion and capacity but doesn't address identity dissolution. Meditation develops differentiation at the deepest level but can leave relational predictions untouched. Talk therapy builds cognitive understanding but rarely completes a thwarted fight response.")}
          </p>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0,marginTop:"0.75rem"}}>
            {T("theory.modality.2","This framework maps 50+ modalities across all nine dimensions, showing where each is effective, partial, or ineffective. The goal isn't collecting modalities — it's seeing clearly which dimensions your current practice covers and which it doesn't.")}
          </p>
        </div>

        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1rem"}}>
          <h2 style={{fontSize:"1.15rem",fontWeight:400,color:C.txL,marginTop:0,marginBottom:"0.75rem"}}>Shadow and {plain?"Wholeness":"Integrity"}</h2>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0}}>
            {T("theory.shadow.1","Every dimension of the cascade can be worked around the shadow rather than through it. You can do somatic work that completes safe impulses while leaving the forbidden ones frozen. You can metabolize acceptable emotions while the shadowed ones stay walled off. You can update comfortable predictions while the deepest projections remain untouched.")}
          </p>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0,marginTop:"0.75rem"}}>
            {T("theory.shadow.2","The felt-sense of shadow work is distinct: not \"finishing what was interrupted\" but \"welcoming home what was banished.\" The rage the kind one won't let the fists express. The vulnerability the strong one has walled off. The desire the spiritual one has transcended. Integrity means structural wholeness — nothing excluded from self-experience. Not moral alignment as a goal, though that follows naturally from wholeness.")}
          </p>
        </div>

        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1rem"}}>
          <h2 style={{fontSize:"1.15rem",fontWeight:400,color:C.txL,marginTop:0,marginBottom:"0.75rem"}}>The Most Reliable Compass</h2>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0}}>
            {T("theory.compass.1","When healing is stuck, the question is always: which dimension of contact am I avoiding? The dimension you're most reluctant to engage is usually the one most needed. The body worker who never does relational work. The meditator who never feels. The talk therapy client who never lets the body complete. The ceremony participant who never integrates sober.")}
          </p>
          <p style={{fontSize:"0.88rem",color:C.txM,lineHeight:1.75,margin:0,marginTop:"0.75rem"}}>
            {T("theory.compass.2","Explore the other tabs to see the full cascade, assess your own program, understand common traps, and use the diagnostic compass.")}
          </p>
        </div>
      </div>}

      {/* ━━ ASSESS ━━ */}
      {view==="assess"&&<div>
        <p style={{fontSize:"0.9rem",color:C.txM,lineHeight:1.6,marginBottom:"1.25rem"}}>{plain?"Select your current practices. The assessment shows how well you're covered across all areas and flags potential blind spots.":"Select your current modalities. The assessment shows coverage across all dimensions and identifies vulnerabilities."}</p>

        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.25rem",marginBottom:"1.5rem"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.75rem"}}>
            <span style={{fontSize:"0.9rem",color:C.txL}}>{plain?"Your Practices":"Your Modalities"} ({mods.size})</span>
            {mods.size>0&&<button onClick={()=>setMods(new Set())} style={{fontSize:"0.75rem",color:C.txM,background:"transparent",border:"none",cursor:"pointer",fontFamily:"inherit",textDecoration:"underline"}}>Clear</button>}
          </div>
          <input type="text" placeholder={plain?"Search practices...":"Search modalities..."} value={ms} onChange={e=>setMs(e.target.value)}
            style={{width:"100%",padding:"0.4rem 0.75rem",background:C.bg,border:`1px solid ${C.bdr}`,borderRadius:6,color:C.txL,fontFamily:"inherit",fontSize:"0.8rem",outline:"none",boxSizing:"border-box",marginBottom:"0.75rem"}}/>
          <div style={{maxHeight:280,overflowY:"auto",display:"flex",flexDirection:"column",gap:"0.15rem"}}>
            {filtMods.map(k=>(
              <div key={k} onClick={()=>toggle(k)} style={{padding:"0.4rem 0.6rem",borderRadius:6,cursor:"pointer",display:"flex",alignItems:"center",gap:"0.5rem",background:mods.has(k)?`${C.acc}18`:"transparent"}}>
                <div style={{width:16,height:16,borderRadius:4,border:`1.5px solid ${mods.has(k)?C.acc:C.bdr}`,background:mods.has(k)?C.acc:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                  {mods.has(k)&&<span style={{color:C.bg,fontSize:"0.7rem",fontWeight:700}}>✓</span>}
                </div>
                <span style={{fontSize:"0.82rem",color:mods.has(k)?C.txL:C.txM}}>{MODS[k]}</span>
              </div>
            ))}
          </div>
        </div>

        {/* Conditions selector — collapsible */}
        <div style={{background:C.card,border:`1px solid ${conds.size>0?C.idn+"44":C.bdr}`,borderRadius:10,overflow:"hidden",marginBottom:"1.5rem",transition:"border-color 0.3s"}}>
          <div onClick={()=>setCondOpen(!condOpen)} style={{padding:"1rem 1.25rem",cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div style={{display:"flex",alignItems:"center",gap:"0.6rem",flexWrap:"wrap"}}>
              <span style={{fontSize:"0.9rem",color:C.txL}}>{plain?"What are you working with?":"Conditions"}</span>
              <span style={{fontSize:"0.72rem",color:C.txM,fontWeight:400}}>(optional)</span>
              {conds.size>0&&<span style={{fontSize:"0.68rem",color:C.idnL,background:`${C.idn}20`,padding:"2px 8px",borderRadius:10}}>{conds.size} selected</span>}
            </div>
            <span style={{color:C.txM,fontSize:"1.1rem",transition:"transform 0.2s",transform:condOpen?"rotate(180deg)":"rotate(0)"}}>{condOpen?"▾":"▸"}</span>
          </div>
          {conds.size>0&&!condOpen&&<div style={{padding:"0 1.25rem 0.75rem",display:"flex",gap:"0.4rem",flexWrap:"wrap"}}>
            {[...conds].map(cId=>{const c=COND_MAP[cId];return c?<span key={cId} style={{fontSize:"0.72rem",color:C.idnL,background:`${C.idn}14`,border:`1px solid ${C.idn}33`,padding:"2px 8px",borderRadius:10,display:"inline-flex",alignItems:"center",gap:"0.35rem"}}>
              {c.name}
              <span onClick={e=>{e.stopPropagation();toggleCond(cId);}} style={{cursor:"pointer",opacity:0.6,fontSize:"0.65rem"}}>✕</span>
            </span>:null;})}
          </div>}
          {condOpen&&<div style={{padding:"0 1.25rem 1.25rem"}}>
            <p style={{fontSize:"0.78rem",color:C.txM,margin:0,marginBottom:"0.75rem",lineHeight:1.5}}>
              {plain?"Select any that apply to tailor your recommendations. This isn't a diagnosis — it helps the tool suggest more relevant approaches."
              :"Select applicable conditions to weight recommendations toward evidence-indicated modalities and flag contraindications. This is informational, not diagnostic."}
            </p>
            {conds.size>0&&<div style={{marginBottom:"0.5rem"}}><button onClick={()=>setConds(new Set())} style={{fontSize:"0.72rem",color:C.txM,background:"transparent",border:"none",cursor:"pointer",fontFamily:"inherit",textDecoration:"underline",padding:0}}>Clear all</button></div>}
            <div style={{display:"flex",flexDirection:"column",gap:"0.35rem"}}>
              {CONDITIONS.map(c=>(
                <div key={c.id} onClick={()=>toggleCond(c.id)} style={{padding:"0.55rem 0.75rem",borderRadius:8,cursor:"pointer",display:"flex",alignItems:"flex-start",gap:"0.6rem",background:conds.has(c.id)?`${C.idn}14`:"transparent",border:`1px solid ${conds.has(c.id)?C.idn+"44":"transparent"}`,transition:"all 0.2s"}}>
                  <div style={{width:16,height:16,borderRadius:4,border:`1.5px solid ${conds.has(c.id)?C.idn:C.bdr}`,background:conds.has(c.id)?C.idn:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:1}}>
                    {conds.has(c.id)&&<span style={{color:C.bg,fontSize:"0.7rem",fontWeight:700}}>✓</span>}
                  </div>
                  <div>
                    <span style={{fontSize:"0.84rem",color:conds.has(c.id)?C.txL:C.txM}}>{c.name}</span>
                    <div style={{fontSize:"0.74rem",color:C.txM,marginTop:2,lineHeight:1.4}}>{plain?c.plainDesc:c.desc}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>}
        </div>

        {/* Condition-informed insights */}
        {conds.size>0&&<div style={{background:C.card,border:`1px solid ${C.idn}33`,borderRadius:10,padding:"1.25rem",marginBottom:"1rem"}}>
          <div style={{fontSize:"0.9rem",color:C.txL,marginBottom:"0.75rem"}}>{plain?"How your conditions shape the recommendations":"Condition-Informed Analysis"}</div>
          {[...conds].map(cId=>{
            const c = COND_MAP[cId]; if(!c) return null;
            const priDims = Object.entries(c.dimWeights).filter(([,w])=>w>=2).sort((a,b)=>b[1]-a[1]).map(([dId])=>DIMS.find(d=>d.id===dId)).filter(Boolean);
            const cautionInUse = [...(c.caution||[]),...(c.contraindicated||[])].filter(id=>mods.has(id));
            const contrainUse = (c.contraindicated||[]).filter(id=>mods.has(id));
            const essentialMissing = (c.essential||[]).filter(id=>!mods.has(id));
            const essentialPresent = (c.essential||[]).filter(id=>mods.has(id));
            return (
              <div key={cId} style={{marginBottom:"1rem",paddingBottom:"1rem",borderBottom:`1px solid ${C.bdr}`}}>
                <div style={{fontSize:"0.88rem",color:C.idnL,marginBottom:"0.4rem"}}>{c.name}</div>
                <div style={{fontSize:"0.78rem",color:C.txM,lineHeight:1.5,marginBottom:"0.5rem"}}>
                  {plain?"Key areas to focus on: ":"Priority dimensions: "}
                  {priDims.map((d,i)=><span key={d.id}>{i>0?", ":""}<span style={{color:d.colorL}}>{dimName(d)}</span></span>)}
                </div>

                {/* Essential modalities status */}
                {(c.essential||[]).length>0&&<div style={{fontSize:"0.78rem",lineHeight:1.5,marginBottom:"0.35rem"}}>
                  <span style={{color:C.accL}}>{plain?"Core practices: ":"Essential modalities: "}</span>
                  {(c.essential||[]).map((id,i)=><span key={id}>{i>0?", ":""}<span style={{color:mods.has(id)?C.accL:C.warnL,fontWeight:mods.has(id)?400:500}}>{MODS[id]}{mods.has(id)?" ✓":" ✗"}</span></span>)}
                </div>}

                {/* Program size guidance */}
                {c.minProgram&&<div style={{fontSize:"0.78rem",color:C.txM,lineHeight:1.5,marginBottom:"0.35rem"}}>
                  {plain?"A solid program: ":"Recommended program size: "}{c.minProgram}–{c.maxProgram} {plain?"practices":"modalities"}
                  {mods.size>0&&<span style={{color:mods.size>=c.minProgram&&mods.size<=c.maxProgram?C.accL:mods.size<c.minProgram?C.warnL:C.par}}> (you have {mods.size})</span>}
                </div>}

                {/* Contraindicated warnings */}
                {contrainUse.length>0&&<div style={{fontSize:"0.78rem",color:C.warn,lineHeight:1.5,marginBottom:"0.35rem"}}>
                  ⛔ {plain?"Strongly discouraged with this condition: ":"Contraindicated — in your current set: "}
                  {contrainUse.map(id=>MODS[id]).join(", ")}
                </div>}

                {/* Caution warnings */}
                {cautionInUse.filter(id=>!contrainUse.includes(id)).length>0&&<div style={{fontSize:"0.78rem",color:C.warnL,lineHeight:1.5,marginBottom:"0.35rem"}}>
                  ⚠ {plain?"Use carefully with this condition: ":"Caution — in your current set: "}
                  {cautionInUse.filter(id=>!contrainUse.includes(id)).map(id=>MODS[id]).join(", ")}
                </div>}

                {c.trapRisk.length>0&&<div style={{fontSize:"0.78rem",color:C.txM,lineHeight:1.5,marginBottom:"0.35rem"}}>
                  {plain?"Watch out for: ":"Elevated trap risk: "}{c.trapRisk.join(", ")}
                </div>}

                {/* Program note */}
                {c.programNote&&<div style={{fontSize:"0.78rem",color:C.txM,lineHeight:1.6,marginTop:"0.5rem",padding:"0.6rem 0.75rem",background:`${C.idn}08`,borderRadius:6,borderLeft:`2px solid ${C.idn}44`}}>
                  {plain&&c.plainProgramNote?c.plainProgramNote:c.programNote}
                </div>}
              </div>
            );
          })}
        </div>}

        {asmnt&&<>
          <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.25rem",marginBottom:"1rem"}}>
            <div style={{fontSize:"0.9rem",color:C.txL,marginBottom:"1rem"}}>{plain?"Coverage Across Areas":"Dimension Coverage"}</div>
            {asmnt.results.map(r=>(
              <div key={r.dim.id} style={{marginBottom:"0.85rem"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.3rem"}}>
                  <span style={{fontSize:"0.82rem",color:C.txL}}>
                    {dimName(r.dim)}
                    {r.dimImportance>1.3&&<span style={{fontSize:"0.6rem",color:C.idnL,marginLeft:"0.4rem",fontWeight:400}}>★ {plain?"priority":"high priority"}</span>}
                  </span>
                  <span style={{fontSize:"0.72rem",color:LVL_C[r.level],fontWeight:500}}>{LVL_L[r.level]}</span>
                </div>
                <div style={{width:"100%",height:8,borderRadius:4,background:C.bdr,overflow:"hidden"}}>
                  <div style={{width:`${r.score}%`,height:"100%",borderRadius:4,background:LVL_C[r.level],transition:"width 0.5s"}}/>
                </div>
                {(r.eMatch.length>0||r.pMatch.length>0||r.harmMatch.length>0)&&<div style={{marginTop:"0.25rem",fontSize:"0.72rem",color:C.txM}}>
                  {r.eMatch.length>0&&<span style={{color:"#7aba8a"}}>● {r.eMatch.join(", ")}</span>}
                  {r.eMatch.length>0&&r.pMatch.length>0&&<span> · </span>}
                  {r.pMatch.length>0&&<span style={{color:"#c0b070"}}>◑ {r.pMatch.join(", ")}</span>}
                  {r.harmMatch.length>0&&<>{(r.eMatch.length>0||r.pMatch.length>0)&&<span> · </span>}<span style={{color:C.warn}}>⛔ {r.harmMatch.join(", ")}</span></>}
                </div>}
                {r.level==="none"&&<div style={{marginTop:"0.25rem",fontSize:"0.72rem",color:C.ineffTx,fontStyle:"italic"}}>
                  {plain?"No coverage — consider: ":"No coverage — consider: "}{(r.dim.eff||[]).slice(0,2).map(m=>m.name).join(", ")}
                </div>}
              </div>
            ))}
          </div>

          {/* Recommendations */}
          {recs && recs.primary && (recs.primary.length > 0 || recs.secondary.length > 0) && (
            <div style={{background:C.card,border:`1px solid ${C.accL}33`,borderRadius:10,padding:"1.25rem",marginBottom:"1rem"}}>
              <div style={{fontSize:"0.9rem",color:C.txL,marginBottom:"0.25rem"}}>{plain?"What to Consider Adding":"Recommended Additions"}</div>
              <p style={{fontSize:"0.78rem",color:C.txM,margin:0,marginBottom:"1rem",lineHeight:1.5}}>{plain?"Based on your gaps and what would best complement what you're already doing.":"Based on your gaps, trap vulnerabilities, and what would best complement your current practice."}</p>

              {recs.primary.length > 0 && <>
                <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.accL,marginBottom:"0.5rem"}}>High Impact</div>
                {recs.primary.map(r => (
                  <div key={r.id} style={{padding:"0.6rem 0",borderTop:`1px solid ${C.bdr}`,display:"flex",gap:"0.75rem",alignItems:"flex-start"}}>
                    <div onClick={()=>toggle(r.id)} style={{width:20,height:20,borderRadius:5,border:`1.5px solid ${C.acc}`,background:"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0,marginTop:2}}>
                      <span style={{color:C.acc,fontSize:"0.75rem"}}>+</span>
                    </div>
                    <div style={{flex:1}}>
                      <div style={{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"}}>
                        <span style={{fontSize:"0.85rem",color:C.txL}}>{r.name}</span>
                        {r.newCats.length > 0 && <span style={{fontSize:"0.62rem",color:C.accL,background:`${C.acc}18`,padding:"1px 6px",borderRadius:8}}>new approach</span>}
                        {r.isEssential && <span style={{fontSize:"0.62rem",color:"#fff",background:C.idn,padding:"1px 6px",borderRadius:8,fontWeight:600}}>essential</span>}
                        {r.tier===2 && <span style={{fontSize:"0.62rem",color:C.idnL,background:`${C.idn}18`,padding:"1px 6px",borderRadius:8}}>recommended</span>}
                        {r.tier===3 && <span style={{fontSize:"0.62rem",color:C.txM,background:`${C.bdr}`,padding:"1px 6px",borderRadius:8}}>helpful</span>}
                        {r.tier===4 && <span style={{fontSize:"0.62rem",color:C.warnL,background:`${C.warn}18`,padding:"1px 6px",borderRadius:8}}>use caution</span>}
                        {r.isContraindicated && <span style={{fontSize:"0.62rem",color:"#fff",background:C.warn,padding:"1px 6px",borderRadius:8,fontWeight:600}}>contraindicated</span>}
                      </div>
                      <div style={{fontSize:"0.76rem",color:C.txM,marginTop:2,lineHeight:1.5}}>{r.reasons.slice(0,2).join(". ")}</div>
                    </div>
                  </div>
                ))}
              </>}

              {recs.secondary.length > 0 && <>
                <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.5rem",marginTop:recs.primary.length>0?"1rem":"0"}}>Also Consider</div>
                {recs.secondary.map(r => (
                  <div key={r.id} style={{padding:"0.5rem 0",borderTop:`1px solid ${C.bdr}`,display:"flex",gap:"0.75rem",alignItems:"flex-start"}}>
                    <div onClick={()=>toggle(r.id)} style={{width:20,height:20,borderRadius:5,border:`1.5px solid ${C.bdr}`,background:"transparent",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",flexShrink:0,marginTop:2}}>
                      <span style={{color:C.txM,fontSize:"0.75rem"}}>+</span>
                    </div>
                    <div style={{flex:1}}>
                      <div style={{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"}}>
                        <span style={{fontSize:"0.82rem",color:C.txL}}>{r.name}</span>
                        {r.isEssential && <span style={{fontSize:"0.62rem",color:"#fff",background:C.idn,padding:"1px 6px",borderRadius:8,fontWeight:600}}>essential</span>}
                        {r.tier===2 && <span style={{fontSize:"0.62rem",color:C.idnL,background:`${C.idn}18`,padding:"1px 6px",borderRadius:8}}>recommended</span>}
                        {r.tier===3 && <span style={{fontSize:"0.62rem",color:C.txM,background:`${C.bdr}`,padding:"1px 6px",borderRadius:8}}>helpful</span>}
                      </div>
                      <div style={{fontSize:"0.74rem",color:C.txM,marginTop:1}}>{r.reasons.slice(0,1).join(". ")}</div>
                    </div>
                  </div>
                ))}
              </>}

              {/* Warnings: contraindicated/caution modalities already in user's set */}
              {recs.warnings && recs.warnings.filter(w=>mods.has(w.id)).length > 0 && <>
                <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.warnL,marginBottom:"0.5rem",marginTop:"1rem"}}>{plain?"In your set — use with care":"Warnings — In Your Current Set"}</div>
                {recs.warnings.filter(w=>mods.has(w.id)).map(r => (
                  <div key={r.id} style={{padding:"0.5rem 0",borderTop:`1px solid ${C.warn}18`,display:"flex",gap:"0.75rem",alignItems:"flex-start"}}>
                    <span style={{color:r.isContraindicated?C.warn:C.warnL,fontSize:"0.85rem",flexShrink:0,marginTop:1}}>{r.isContraindicated?"⛔":"⚠"}</span>
                    <div style={{flex:1}}>
                      <span style={{fontSize:"0.82rem",color:C.txL}}>{r.name}</span>
                      <span style={{fontSize:"0.62rem",color:r.isContraindicated?"#fff":C.warnL,background:r.isContraindicated?C.warn:`${C.warn}18`,padding:"1px 6px",borderRadius:8,marginLeft:"0.5rem"}}>{r.isContraindicated?"contraindicated":"caution"}</span>
                      <div style={{fontSize:"0.74rem",color:C.txM,marginTop:2}}>{r.reasons.filter(r2=>r2.includes("⚠")||r2.includes("⛔")).slice(0,1).join("")||"Review appropriateness for your conditions"}</div>
                    </div>
                  </div>
                ))}
              </>}
            </div>
          )}

          <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.25rem",marginBottom:"1rem"}}>
            <div style={{fontSize:"0.9rem",color:C.txL,marginBottom:"1rem"}}>{plain?"Common Pitfall Risks":"Trap Vulnerability"}</div>
            {asmnt.trapRisks.filter(t=>t.risk!=="low").length===0
              ? <p style={{fontSize:"0.85rem",color:C.accL,margin:0}}>{plain?"Good coverage — no major risks detected.":"Good coverage — no high-risk vulnerabilities detected."}</p>
              : asmnt.trapRisks.filter(t=>t.risk!=="low").map(t=>(
              <div key={t.name} style={{padding:"0.6rem 0",borderTop:`1px solid ${C.bdr}`}}>
                <div style={{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.25rem"}}>
                  <span style={{color:t.risk==="high"?C.warn:C.par,fontSize:"0.75rem"}}>{t.risk==="high"?"⚠":"◑"}</span>
                  <span style={{fontSize:"0.88rem",color:C.txL}}>{t.name}</span>
                  <span style={{fontSize:"0.68rem",color:t.risk==="high"?C.warnL:"#c0b070",background:t.risk==="high"?`${C.warn}18`:`${C.par}18`,padding:"1px 8px",borderRadius:10}}>{t.risk}</span>
                </div>
                <p style={{fontSize:"0.78rem",color:C.txM,margin:0,lineHeight:1.5}}>{t.desc}</p>
              </div>
            ))}
          </div>

          <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.25rem",marginBottom:"1.5rem"}}>
            <div style={{fontSize:"0.9rem",color:C.txL,marginBottom:"0.75rem"}}>Summary</div>
            <p style={{fontSize:"0.85rem",color:C.txM,lineHeight:1.7,margin:0}}>{(()=>{
              const gaps=asmnt.results.filter(r=>r.level==="none"||r.level==="weak");
              const strs=asmnt.results.filter(r=>r.level==="strong");
              let s="";
              if(strs.length>0) s+=`Strong coverage in ${strs.map(x=>dimName(x.dim)).join(", ")}. `;
              if(gaps.length>0) s+=`Gaps in ${gaps.map(x=>dimName(x.dim)).join(", ")} — ${plain?"consider adding practices for these areas.":"consider adding modalities for these dimensions."} `;
              if(!gaps.length&&strs.length>=5) s+=(plain?"Good all-around coverage. Focus on going deeper rather than broader. ":"Comprehensive coverage. The question becomes depth over breadth. ");
              if(mods.size<=2) s+=(plain?"With only a few practices, you'll have blind spots. ":"A narrow set of modalities will have blind spots. ");
              if(mods.size>=8) s+=(plain?"That's a lot of practices — make sure you're going deep in some, not just sampling. ":"Many modalities — watch for technique accumulation. Depth in a few may serve better. ");
              return s||(plain?"Select practices above to see your assessment.":"Select modalities above to see your assessment.");
            })()}</p>
          </div>

          {/* ━━ Actions: Export / Book / Donate ━━ */}
          <div style={{background:C.card,border:`1px solid ${C.acc}33`,borderRadius:10,padding:"1.25rem",marginBottom:"1.5rem"}}>
            <div style={{display:"flex",flexDirection:"column",gap:"1rem"}}>

              {/* Export PDF with email capture */}
              {!exportSent?<div>
                <div style={{fontSize:"0.88rem",color:C.txL,marginBottom:"0.4rem"}}>{plain?"Save your assessment":"Export Assessment as PDF"}</div>
                <p style={{fontSize:"0.78rem",color:C.txM,margin:"0 0 0.6rem",lineHeight:1.5}}>Get a PDF of your full assessment — coverage, gaps, recommendations, and condition analysis. Enter your email and we'll also send occasional updates on the framework.</p>
                <div style={{display:"flex",gap:"0.5rem",flexWrap:"wrap",alignItems:"center"}}>
                  <input value={exportEmail} onChange={e=>setExportEmail(e.target.value)} placeholder="your@email.com" type="email"
                    style={{flex:"1 1 200px",padding:"0.5rem 0.75rem",background:C.bg,border:`1px solid ${C.bdr}`,borderRadius:6,color:C.txL,fontFamily:"inherit",fontSize:"0.82rem",outline:"none"}}/>
                  <button onClick={()=>{
                    if(!exportEmail||!exportEmail.includes("@")){alert("Please enter a valid email.");return;}
                    generatePDF();
                    setExportSent(true);
                  }} style={{padding:"0.5rem 1.25rem",background:C.acc,color:C.bg,border:"none",borderRadius:6,cursor:"pointer",fontFamily:"inherit",fontSize:"0.82rem",fontWeight:500,whiteSpace:"nowrap"}}>
                    ⬇ Download PDF
                  </button>
                </div>
                <p style={{fontSize:"0.68rem",color:C.txM,margin:"0.4rem 0 0",opacity:0.7}}>No spam. Unsubscribe anytime. Your email is stored locally only.</p>
              </div>
              :<div style={{display:"flex",alignItems:"center",gap:"0.5rem"}}>
                <span style={{color:C.accL,fontSize:"0.85rem"}}>✓</span>
                <span style={{fontSize:"0.82rem",color:C.accL}}>PDF downloaded! Check your downloads folder.</span>
                <button onClick={()=>setExportSent(false)} style={{fontSize:"0.72rem",color:C.txM,background:"transparent",border:"none",cursor:"pointer",fontFamily:"inherit",textDecoration:"underline",marginLeft:"auto"}}>Export again</button>
              </div>}

              <div style={{borderTop:`1px solid ${C.bdr}`,paddingTop:"1rem"}}>
                {/* Book a session */}
                <div style={{display:"flex",gap:"1rem",flexWrap:"wrap",alignItems:"flex-start"}}>
                  <div style={{flex:"1 1 250px"}}>
                    <div style={{fontSize:"0.88rem",color:C.txL,marginBottom:"0.3rem"}}>{plain?"Want help building your program?":"Program Design Session"}</div>
                    <p style={{fontSize:"0.78rem",color:C.txM,margin:0,lineHeight:1.5}}>Book a 1-on-1 session to design a personalized healing program based on your assessment, conditions, and life context.</p>
                  </div>
                  <a href="https://calendly.com" target="_blank" rel="noopener noreferrer"
                    style={{padding:"0.5rem 1.25rem",background:`${C.idn}20`,color:C.idnL,border:`1px solid ${C.idn}44`,borderRadius:6,fontFamily:"inherit",fontSize:"0.82rem",textDecoration:"none",whiteSpace:"nowrap",alignSelf:"center"}}>
                    Book a Session →
                  </a>
                </div>
              </div>

              <div style={{borderTop:`1px solid ${C.bdr}`,paddingTop:"1rem"}}>
                {/* Donate */}
                <div style={{display:"flex",gap:"1rem",flexWrap:"wrap",alignItems:"flex-start"}}>
                  <div style={{flex:"1 1 250px"}}>
                    <div style={{fontSize:"0.88rem",color:C.txL,marginBottom:"0.3rem"}}>{plain?"Support this tool":"Support the Healing Spiral"}</div>
                    <p style={{fontSize:"0.78rem",color:C.txM,margin:0,lineHeight:1.5}}>This tool is free and always will be. If it's been valuable to you, consider contributing to support its continued development.</p>
                  </div>
                  <a href="https://buymeacoffee.com" target="_blank" rel="noopener noreferrer"
                    style={{padding:"0.5rem 1.25rem",background:`${C.gnd}20`,color:C.gndL,border:`1px solid ${C.gnd}44`,borderRadius:6,fontFamily:"inherit",fontSize:"0.82rem",textDecoration:"none",whiteSpace:"nowrap",alignSelf:"center"}}>
                    ♡ Contribute
                  </a>
                </div>
              </div>

            </div>
          </div>

          <div style={{fontSize:"0.8rem",color:C.txM,marginBottom:"0.75rem"}}>{plain?"Click each area to explore details:":"Click dimensions to explore details:"}</div>
          {renderDim("ground")}<Line/>
          {CASCADE.map((id,i)=><div key={id}>{renderDim(id,i)}{i<CASCADE.length-1&&<Arrow/>}</div>)}
          <div style={{display:"flex",justifyContent:"center",padding:"0.5rem 0"}}><div style={{fontSize:"0.75rem",color:C.txM,textAlign:"center",fontStyle:"italic",padding:"0.6rem 1.25rem",border:`1px dashed ${C.bdr}`,borderRadius:8}}>{plain?'↻ The process circles back — each time going deeper':'↻ Spiral returns to capacity at greater depth'}</div></div>
          <div style={{marginTop:"0.75rem",display:"flex",flexDirection:"column",gap:"0.75rem"}}>
            <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,textAlign:"center"}}>{plain?"Cross-Cutting Areas":"Orthogonal Dimensions"}</div>
            {renderDim("energetic",6,true)}
            {renderDim("shadow",7,true)}
          </div>
        </>}
      </div>}

      {/* ━━ CASCADE ━━ */}
      {view==="cascade"&&<>
        {renderDim("ground")}<Line/>
        {CASCADE.map((id,i)=><div key={id}>{renderDim(id,i)}{i<CASCADE.length-1&&<Arrow/>}</div>)}
        <div style={{display:"flex",justifyContent:"center",padding:"0.5rem 0"}}><div style={{fontSize:"0.75rem",color:C.txM,textAlign:"center",fontStyle:"italic",padding:"0.75rem 1.5rem",border:`1px dashed ${C.bdr}`,borderRadius:8,maxWidth:400}}>{plain?'↻ The process circles back — each time going deeper':'↻ Spiral returns to capacity at greater depth'}</div></div>
        <div style={{marginTop:"1rem",display:"flex",flexDirection:"column",gap:"0.75rem"}}>
          <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,textAlign:"center",marginTop:"0.5rem"}}>{plain?"Cross-Cutting Areas — weave through everything":"Orthogonal Dimensions — run throughout, not stages"}</div>
          {renderDim("energetic",6,true)}
          {renderDim("shadow",7,true)}
        </div>
      </>}

      {/* ━━ MODALITIES ━━ */}
      {view==="modalities"&&<div>
        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.25rem",marginBottom:"1.25rem"}}>
          <p style={{fontSize:"0.9rem",color:C.txM,lineHeight:1.7,margin:0}}>
            {plain
              ?"A reference guide to all the healing approaches in this tool — what they are, how they work, and where to learn more."
              :"Comprehensive reference for all modalities included in the Healing Spiral framework. Each entry describes the modality's mechanism, strengths, and appropriate context."}
          </p>
        </div>
        {Object.entries(CAT_LABELS).map(([catId, catLabel])=>{
          const catMods = (MOD_CATS[catId]||[]).filter(id=>MOD_INFO[id]);
          if(catMods.length===0) return null;
          return (
            <div key={catId} style={{marginBottom:"1.5rem"}}>
              <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.12em",color:C.txM,marginBottom:"0.5rem",paddingBottom:"0.35rem",borderBottom:`1px solid ${C.bdr}`}}>{catLabel}</div>
              <div style={{display:"flex",flexDirection:"column",gap:"0.25rem"}}>
                {catMods.map(id=>{
                  const info = MOD_INFO[id];
                  const isOpen = openMod===id;
                  const inSet = mods.has(id);
                  // Find which dims this modality is effective/partial in
                  const dimRoles = [];
                  DIMS.forEach(d=>{
                    if((d.eff||[]).some(m=>m.id===id)){const m=(d.eff||[]).find(m=>m.id===id);dimRoles.push({dim:d,tier:"eff",role:m.role});}
                    else if((d.par||[]).some(m=>m.id===id)){const m=(d.par||[]).find(m=>m.id===id);dimRoles.push({dim:d,tier:"par",role:m.role});}
                  });
                  return (
                    <div key={id} style={{background:isOpen?C.cardH:C.card,border:`1px solid ${isOpen?C.bdr:inSet?C.acc+"44":"transparent"}`,borderRadius:8,overflow:"hidden",transition:"all 0.2s"}}>
                      <div onClick={()=>setOpenMod(isOpen?null:id)} style={{padding:"0.65rem 0.85rem",cursor:"pointer",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                        <div style={{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"}}>
                          <span style={{fontSize:"0.88rem",color:C.txL}}>{MODS[id]}</span>
                          {inSet&&<span style={{fontSize:"0.6rem",color:C.accL,background:`${C.acc}18`,padding:"1px 6px",borderRadius:8}}>in your set</span>}
                        </div>
                        <span style={{color:C.txM,fontSize:"0.85rem",transition:"transform 0.2s",transform:isOpen?"rotate(180deg)":"rotate(0)"}}>{isOpen?"▾":"▸"}</span>
                      </div>
                      {isOpen&&<div style={{padding:"0 0.85rem 0.85rem"}}>
                        <p style={{fontSize:"0.82rem",color:C.txM,lineHeight:1.65,margin:"0 0 0.75rem 0"}}>{plain&&info.plain?info.plain:info.desc}</p>

                        {dimRoles.length>0&&<div style={{marginBottom:"0.75rem"}}>
                          <div style={{fontSize:"0.72rem",color:C.txM,marginBottom:"0.35rem",fontWeight:500}}>{plain?"How it contributes:":"Dimension coverage:"}</div>
                          <div style={{display:"flex",flexDirection:"column",gap:"0.2rem"}}>
                            {dimRoles.map(dr=>(
                              <div key={dr.dim.id} style={{fontSize:"0.76rem",display:"flex",alignItems:"flex-start",gap:"0.4rem",lineHeight:1.5}}>
                                <span style={{color:dr.tier==="eff"?"#7aba8a":"#c0b070",flexShrink:0}}>{dr.tier==="eff"?"●":"◑"}</span>
                                <span><span style={{color:dr.dim.colorL}}>{dimName(dr.dim)}</span><span style={{color:C.txM}}> — {dr.role}</span></span>
                              </div>
                            ))}
                          </div>
                        </div>}

                        <div style={{display:"flex",gap:"0.5rem",alignItems:"center",flexWrap:"wrap"}}>
                          {!inSet&&<button onClick={()=>toggle(id)} style={{fontSize:"0.76rem",color:C.acc,background:`${C.acc}12`,border:`1px solid ${C.acc}44`,borderRadius:6,padding:"0.3rem 0.75rem",cursor:"pointer",fontFamily:"inherit"}}>+ Add to my {plain?"practices":"program"}</button>}
                          {inSet&&<button onClick={()=>toggle(id)} style={{fontSize:"0.76rem",color:C.warnL,background:`${C.warn}12`,border:`1px solid ${C.warn}33`,borderRadius:6,padding:"0.3rem 0.75rem",cursor:"pointer",fontFamily:"inherit"}}>− Remove</button>}
                          {info.url&&<a href={info.url} target="_blank" rel="noopener noreferrer" style={{fontSize:"0.76rem",color:C.idnL,background:`${C.idn}12`,border:`1px solid ${C.idn}33`,borderRadius:6,padding:"0.3rem 0.75rem",textDecoration:"none",display:"inline-flex",alignItems:"center",gap:"0.3rem"}}>↗ {info.urlLabel||"Learn more"}</a>}
                        </div>
                      </div>}
                    </div>
                  );
                })}
              </div>
            </div>
          );
                <div style={{marginBottom:"1.25rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.5rem"}}>Signs</div>
                  <div style={{display:"flex",flexDirection:"column",gap:"0.3rem"}}>
                    {c.keys.map((k,i)=>(
                      <div key={i} style={{display:"flex",gap:"0.5rem",alignItems:"flex-start"}}>
                        <span style={{color:dim.colorL,fontSize:"0.55rem",marginTop:5,flexShrink:0}}>◆</span>
                        <span style={{fontSize:"0.82rem",color:C.txM,lineHeight:1.5}}>{k}</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Invitation */}
                <div style={{background:`${dim.color}08`,border:`1px solid ${dim.color}22`,borderRadius:8,padding:"1rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:dim.colorL,marginBottom:"0.5rem"}}>An invitation</div>
                  <p style={{fontSize:"0.84rem",color:C.txM,lineHeight:1.7,margin:0}}>{T("compass."+dim.id+".invite",c.invite)}</p>
                </div>

                {/* Expandable modality detail */}
                <div style={{marginTop:"1.25rem",borderTop:`1px solid ${C.bdr}`,paddingTop:"1rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:dim.colorL,marginBottom:"0.75rem"}}>{plain?'Approaches for this area':'Modalities for this dimension'}</div>
                  <Detail dim={dim} mf={mf} setMf={setMf} sel={sel} st={st} setSt={setSt} plain={plain}/>
                </div>
              </div>}
            </div>);
        })
      </div>

      {/* ──── COMPASS ──── */}
      {view==="compass"&&<div>
        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1.5rem"}}>
          <p style={{fontSize:"0.9rem",color:C.txM,lineHeight:1.7,margin:0}}>
            When healing feels stuck, the most reliable compass is: <em style={{color:C.accL}}>which {plain?"area":"dimension"} am I avoiding?</em> The {plain?"area":"dimension"} you're most reluctant to engage is usually the one most needed. Click each to explore what stuckness feels like there — and what might help.
          </p>
        </div>

        <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.75rem"}}>{plain?"The Main Sequence":"The Cascade"}</div>
        <div style={{display:"flex",flexDirection:"column",gap:"0.6rem",marginBottom:"1.5rem"}}>
          {DIMS.filter(d=>CASCADE.includes(d.id)).map(dim=>{
            const c = COMPASS[dim.id]; if(!c) return null;
            const isOpen = sel===dim.id;
              <span style={{color:C.txM,fontSize:"1.2rem",flexShrink:0}}>{isOpen?"−":"+"}</span>
            </div>

            {isOpen&&<div style={{padding:"0 1.25rem 1.5rem 1.25rem",borderTop:`1px solid ${C.bdr}`,animation:"fadeIn 0.3s ease"}}>
              <div style={{marginTop:"1.25rem",marginBottom:"1.25rem"}}>
                <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.warnL,marginBottom:"0.5rem"}}>What it looks like</div>
                <p style={{fontSize:"0.84rem",color:C.txM,lineHeight:1.7,margin:0,fontStyle:"italic"}}>{T("trap."+ti+".looks",t.looks)}</p>
              </div>

              <div style={{marginBottom:"1.25rem"}}>
                <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.5rem"}}>Signs you might be here</div>
                <div style={{display:"flex",flexDirection:"column",gap:"0.35rem"}}>
                  {(plain&&t.plainSigns?t.plainSigns:t.signs).map((s,i)=>(
                    <div key={i} style={{display:"flex",gap:"0.5rem",alignItems:"flex-start"}}>
                      <span style={{color:C.warn,fontSize:"0.6rem",marginTop:5,flexShrink:0}}>◆</span>
                      <span style={{fontSize:"0.82rem",color:C.txM,lineHeight:1.5}}>{s}</span>
                    </div>
                  ))}
                </div>
              </div>

              {t.risk.length>0&&<div style={{marginBottom:"1.25rem"}}>
                <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.5rem"}}>{plain?"Approaches that can contribute to this":"Modalities that can contribute"}</div>
                <div style={{display:"flex",gap:"0.35rem",flexWrap:"wrap"}}>
                  {t.risk.map(id=><span key={id} style={{fontSize:"0.74rem",color:C.txM,background:`${C.warn}12`,border:`1px solid ${C.warn}22`,padding:"3px 10px",borderRadius:6}}>{MODS[id]}</span>)}
                </div>
              </div>}

              <div style={{background:`${C.acc}08`,border:`1px solid ${C.acc}22`,borderRadius:8,padding:"1rem"}}>
                <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.accL,marginBottom:"0.5rem"}}>The way through</div>
                <p style={{fontSize:"0.84rem",color:C.txM,lineHeight:1.7,margin:0}}>{T("trap."+ti+".antidote",t.antidote)}</p>
              </div>
            </div>}
          </div>);
        })}\n      </div>}

      {/* ──── COMPASS ──── */}
      {view==="compass"&&<div>
        <div style={{background:C.card,border:`1px solid ${C.bdr}`,borderRadius:10,padding:"1.5rem",marginBottom:"1.5rem"}}>
          <p style={{fontSize:"0.9rem",color:C.txM,lineHeight:1.7,margin:0}}>
            When healing feels stuck, the most reliable compass is: <em style={{color:C.accL}}>which {plain?"area":"dimension"} am I avoiding?</em> The {plain?"area":"dimension"} you're most reluctant to engage is usually the one most needed. Click each to explore what stuckness feels like there — and what might help.
          </p>
        </div>

        <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.75rem"}}>{plain?"The Main Sequence":"The Cascade"}</div>
        <div style={{display:"flex",flexDirection:"column",gap:"0.6rem",marginBottom:"1.5rem"}}>
          {DIMS.filter(d=>CASCADE.includes(d.id)).map(dim=>{
            const c = COMPASS[dim.id]; if(!c) return null;
            const isOpen = sel===dim.id;
          })}
        </div>

        <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.75rem"}}>{plain?"Cross-Cutting Areas — weave through everything":"Orthogonal Dimensions — run throughout"}</div>
        <div style={{display:"flex",flexDirection:"column",gap:"0.6rem"}}>
          {DIMS.filter(d=>["energetic","shadow"].includes(d.id)).map(dim=>{
            const c = COMPASS[dim.id]; if(!c) return null;
            const isOpen = sel===dim.id;
            return(<div key={dim.id}>
              <div onClick={()=>pick(dim.id)} style={{background:isOpen?C.cardH:C.card,border:`1px dashed ${isOpen?dim.colorL:C.bdr}`,borderRadius:10,padding:"1rem 1.25rem",cursor:"pointer",transition:"all 0.25s"}}>
                <div style={{display:"flex",alignItems:"center",gap:"0.75rem"}}>
                  <div style={{width:10,height:10,borderRadius:"50%",background:dim.color,flexShrink:0}}/>
                  <div style={{flex:1}}>
                    <div style={{display:"flex",alignItems:"center",gap:"0.5rem"}}>
                      <span style={{fontSize:"0.95rem",color:C.txL}}>{dimName(dim)}</span>
                      <span style={{fontSize:"0.6rem",color:dim.colorL,background:`${dim.color}18`,padding:"1px 6px",borderRadius:8}}>{plain?"CROSS-CUTTING":"ORTHOGONAL"}</span>
                    </div>
                    <div style={{fontSize:"0.84rem",color:isOpen?dim.colorL:C.txM,marginTop:3,fontStyle:"italic"}}>{T("compass."+dim.id+".q",c.q)}</div>
                  </div>
                  <span style={{color:C.txM,fontSize:"1.2rem",flexShrink:0}}>{isOpen?"−":"+"}</span>
                </div>
              </div>
              {isOpen&&<div style={{background:C.card,border:`1px dashed ${dim.colorL}33`,borderTop:"none",borderRadius:"0 0 10px 10px",padding:"1.25rem",marginTop:"-2px",animation:"fadeIn 0.3s ease"}}>
                <div style={{marginBottom:"1.25rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:dim.colorL,marginBottom:"0.5rem"}}>Check in with your body</div>
                  <p style={{fontSize:"0.84rem",color:C.txM,lineHeight:1.7,margin:0}}>{T("compass."+dim.id+".body",c.body)}</p>
                </div>
                <div style={{marginBottom:"1.25rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.5rem"}}>{plain?"When this area is stuck":"When this dimension is stuck"}</div>
                  <p style={{fontSize:"0.84rem",color:C.txM,lineHeight:1.7,margin:0}}>{T("compass."+dim.id+".stuck",c.stuck)}</p>
                </div>
                <div style={{marginBottom:"1.25rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM,marginBottom:"0.5rem"}}>Signs</div>
                  <div style={{display:"flex",flexDirection:"column",gap:"0.3rem"}}>
                    {c.keys.map((k,i)=>(
                      <div key={i} style={{display:"flex",gap:"0.5rem",alignItems:"flex-start"}}>
                        <span style={{color:dim.colorL,fontSize:"0.55rem",marginTop:5,flexShrink:0}}>◆</span>
                        <span style={{fontSize:"0.82rem",color:C.txM,lineHeight:1.5}}>{k}</span>
                      </div>
                    ))}
                  </div>
                </div>
                <div style={{background:`${dim.color}08`,border:`1px solid ${dim.color}22`,borderRadius:8,padding:"1rem",marginBottom:"1.25rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:dim.colorL,marginBottom:"0.5rem"}}>An invitation</div>
                  <p style={{fontSize:"0.84rem",color:C.txM,lineHeight:1.7,margin:0}}>{T("compass."+dim.id+".invite",c.invite)}</p>
                </div>
                <div style={{borderTop:`1px solid ${C.bdr}`,paddingTop:"1rem"}}>
                  <div style={{fontSize:"0.72rem",textTransform:"uppercase",letterSpacing:"0.1em",color:dim.colorL,marginBottom:"0.75rem"}}>{plain?'Approaches for this area':'Modalities for this dimension'}</div>
                  <Detail dim={dim} mf={mf} setMf={setMf} sel={sel} st={st} setSt={setSt} plain={plain}/>
                </div>
              </div>}
            </div>);
          })}
        </div>
      </div>}

      {/* ──── Legend ──── */}
      <div style={{marginTop:"2.5rem",paddingTop:"1.5rem",borderTop:`1px solid ${C.bdr}`}}>
        <div style={{display:"flex",gap:"1.5rem",flexWrap:"wrap",marginBottom:"1.25rem"}}>
          <div style={{display:"flex",flexDirection:"column",gap:"0.4rem"}}>
            <div style={{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM}}>Zones</div>
            <div style={{display:"flex",gap:"0.75rem",flexWrap:"wrap"}}>
              {[["Ground",C.gnd],["Body",C.som],["Psyche",C.psy],["Identity",C.idn],["Subtle",C.eng],["Shadow",C.shd]].map(([l,c])=>(
                <div key={l} style={{display:"flex",alignItems:"center",gap:"0.35rem"}}><div style={{width:7,height:7,borderRadius:"50%",background:c}}/><span style={{fontSize:"0.72rem",color:C.txM}}>{l}</span></div>
              ))}
            </div>
          </div>
          <div style={{display:"flex",flexDirection:"column",gap:"0.4rem"}}>
            <div style={{fontSize:"0.7rem",textTransform:"uppercase",letterSpacing:"0.1em",color:C.txM}}>Coverage</div>
            <div style={{display:"flex",gap:"0.75rem",flexWrap:"wrap"}}>
              {[["Strong",C.strong],["Moderate",C.moderate],["Weak",C.weak],["Gap",C.none]].map(([l,c])=>(
                <div key={l} style={{display:"flex",alignItems:"center",gap:"0.35rem"}}><div style={{width:7,height:7,borderRadius:"50%",background:c}}/><span style={{fontSize:"0.72rem",color:C.txM}}>{l}</span></div>
              ))}
            </div>
          </div>
        </div>
        <div style={{display:"flex",gap:"0.75rem",flexWrap:"wrap",alignItems:"center",paddingTop:"0.75rem",borderTop:`1px solid ${C.bdr}`}}>
          <span style={{fontSize:"0.75rem",color:C.txM,marginRight:"auto"}}>The Healing Spiral — free, open, always.</span>
          <a href="https://buymeacoffee.com" target="_blank" rel="noopener noreferrer" style={{fontSize:"0.72rem",color:C.gndL,textDecoration:"none",padding:"0.3rem 0.7rem",border:`1px solid ${C.gnd}33`,borderRadius:5}}>❥ Support</a>
          <a href="https://calendly.com" target="_blank" rel="noopener noreferrer" style={{fontSize:"0.72rem",color:C.idnL,textDecoration:"none",padding:"0.3rem 0.7rem",border:`1px solid ${C.idn}33`,borderRadius:5}}>Book a Session</a>
        </div>
      </div>

      <style>{`@import url('https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,300;0,6..72,400;0,6..72,600;1,6..72,300;1,6..72,400&display=swap');
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:#0a0a0f}::-webkit-scrollbar-thumb{background:#2a2a3a;border-radius:3px}`}</style>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
</script>
</body>
</html>

